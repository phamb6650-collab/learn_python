<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Master - H·ªçc L·∫≠p Tr√¨nh Python T·ª´ A-Z</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <!-- PrismJS cho Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

    <!-- PyScript: Ch·∫°y Python tr√™n tr√¨nh duy·ªát -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <!-- Canvas Confetti: Hi·ªáu ·ª©ng ph√°o hoa -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        pre, code {
            font-family: 'Fira Code', monospace !important;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #374151; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563; 
        }
        
        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-item.active {
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }

        /* Flashcard 3D Effects */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        /* Puzzle Block Styles */
        .puzzle-block {
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        /* Battle Animations */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-anim { animation: shake 0.5s; }
        .damage-text { animation: fadeUp 1s forwards; }
        @keyframes fadeUp { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }

        /* Typing Game Styles */
        .t-char {
            position: relative;
            transition: color 0.1s;
        }
        .t-char.correct { color: #4ade80; text-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
        .t-char.incorrect { color: #f87171; text-decoration: underline; }
        .t-char.current {
            background-color: rgba(251, 191, 36, 0.2);
            border-bottom: 2px solid #fbbf24;
        }
        .t-char.current::after {
            content: '|';
            position: absolute;
            right: -4px;
            color: #fbbf24;
            animation: blink 1s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex overflow-hidden">
    <!-- Matrix Canvas Background -->
    <canvas id="matrix-canvas" class="fixed inset-0 z-0 opacity-10 pointer-events-none hidden"></canvas>

    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col flex-shrink-0 transition-all duration-300" id="sidebar">
        <div class="p-6 flex items-center justify-center border-b border-gray-700">
            <i class="fa-brands fa-python text-4xl text-yellow-400 mr-3"></i>
            <h1 class="text-xl font-bold tracking-wider">PyMaster</h1>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-2 px-3">
                <li>
                    <button onclick="renderView('home')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center active" id="nav-home">
                        <i class="fa-solid fa-house w-6"></i> T·ªïng quan
                    </button>
                </li>
                <li>
                    <button onclick="renderView('roadmap')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center" id="nav-roadmap">
                        <i class="fa-solid fa-map w-6"></i> L·ªô tr√¨nh h·ªçc
                    </button>
                </li>
                <li>
                    <button onclick="renderView('playground')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center" id="nav-playground">
                        <i class="fa-solid fa-terminal w-6"></i> Playground <span class="ml-2 text-[10px] bg-yellow-500 text-black px-1 rounded font-bold">M·ªöI</span>
                    </button>
                </li>
                <li>
                    <button onclick="renderView('flashcards')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center" id="nav-flashcards">
                        <i class="fa-solid fa-layer-group w-6"></i> Flashcards <span class="ml-2 text-[10px] bg-pink-500 text-white px-1 rounded font-bold">√îN T·∫¨P</span>
                    </button>
                </li>
                <li>
                    <button onclick="renderView('puzzles')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center" id="nav-puzzles">
                        <i class="fa-solid fa-puzzle-piece w-6"></i> X·∫øp h√¨nh Code <span class="ml-2 text-[10px] bg-indigo-500 text-white px-1 rounded font-bold">GAME</span>
                    </button>
                </li>
                <li>
                    <button onclick="renderView('typing')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center" id="nav-typing">
                        <i class="fa-solid fa-keyboard w-6"></i> Luy·ªán g√µ Code <span class="ml-2 text-[10px] bg-cyan-500 text-white px-1 rounded font-bold">T·ªêC ƒê·ªò</span>
                    </button>
                </li>
                <li>
                    <button onclick="renderView('boss')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center" id="nav-boss">
                        <i class="fa-solid fa-skull w-6"></i> SƒÉn Boss <span class="ml-2 text-[10px] bg-red-600 text-white px-1 rounded font-bold">RPG</span>
                    </button>
                </li>
                <li>
                    <button onclick="renderView('profile')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center" id="nav-profile">
                        <i class="fa-solid fa-id-card w-6"></i> H·ªì s∆° & Th√†nh t√≠ch <span class="ml-2 text-[10px] bg-yellow-500 text-black px-1 rounded font-bold">XP</span>
                    </button>
                </li>
                <li>
                    <button onclick="renderView('snippets')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center" id="nav-snippets">
                        <i class="fa-solid fa-book-bookmark w-6"></i> Th∆∞ vi·ªán Code <span class="ml-2 text-[10px] bg-teal-500 text-white px-1 rounded font-bold">M·∫™U</span>
                    </button>
                </li>
                <li class="px-4 mt-4 mb-2">
                    <input type="text" id="search-lesson" placeholder="T√¨m b√†i h·ªçc..." class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm text-gray-300 focus:outline-none focus:border-blue-500 transition" onkeyup="filterLessons()">
                </li>
                <li>
                    <div class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-4">B√†i h·ªçc</div>
                </li>
                <!-- Dynamic Lesson List will be injected here -->
                <div id="lesson-list"></div>
                
                <li>
                    <div class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-4">Th·ª±c h√†nh</div>
                </li>
                <li>
                    <button onclick="renderView('exercises')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center" id="nav-exercises">
                        <i class="fa-solid fa-code w-6"></i> B√†i t·∫≠p & Quiz
                    </button>
                </li>
            </ul>
        </nav>

        <div class="p-4 border-t border-gray-700 text-center text-xs text-gray-500">
            &copy; 2024 Python Master Class
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <!-- Header -->
        <header class="h-16 bg-gray-800/80 backdrop-blur-md border-b border-gray-700 flex items-center justify-between px-8 z-10">
            <h2 id="page-title" class="text-xl font-semibold text-white">Trang ch·ªß</h2>
            <div class="flex items-center space-x-4">
                <!-- Music Player -->
                <div class="hidden lg:flex items-center mr-2 bg-gray-900/80 rounded-full px-4 py-1 border border-purple-500/30 hover:border-purple-500 transition shadow-[0_0_15px_rgba(168,85,247,0.15)]">
                    <div class="flex items-center gap-3">
                        <div class="text-purple-400" id="music-visualizer"><i class="fa-solid fa-music"></i></div>
                        <div class="flex flex-col w-24 overflow-hidden">
                            <span class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Lofi Chill</span>
                            <span id="track-name" class="text-xs text-white truncate font-mono">Loading...</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="prevTrack()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-backward-step text-xs"></i></button>
                            <button onclick="toggleMusic()" class="text-white hover:text-purple-400 transition transform hover:scale-110"><i id="music-play-icon" class="fa-solid fa-circle-play text-xl"></i></button>
                            <button onclick="nextTrack()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-forward-step text-xs"></i></button>
                        </div>
                    </div>
                    <audio id="bg-music"></audio>
                </div>

                <!-- Pomodoro Timer -->
                <div class="hidden md:flex items-center mr-2 bg-gray-700/50 rounded-full px-4 py-1 border border-gray-600 hover:border-blue-500 transition group">
                    <i class="fa-regular fa-clock text-blue-400 mr-2 group-hover:animate-spin" style="animation-duration: 3s;"></i>
                    <span id="pomodoro-timer" class="font-mono font-bold text-gray-200 mr-3">25:00</span>
                    <button onclick="togglePomodoro()" class="text-gray-400 hover:text-white transition" title="B·∫Øt ƒë·∫ßu/D·ª´ng">
                        <i id="pomodoro-icon" class="fa-solid fa-play"></i>
                    </button>
                </div>

                <div class="text-sm text-gray-400">Ti·∫øn ƒë·ªô: <span id="progress-text" class="text-green-400 font-bold">0%</span></div>
                <div class="w-32 h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-green-500 w-0 transition-all duration-500"></div>
                </div>
                <button id="btn-certificate" onclick="renderView('certificate')" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs font-bold transition animate-pulse">
                    <i class="fa-solid fa-award"></i> Nh·∫≠n ch·ª©ng ch·ªâ
                </button>
                <button onclick="toggleMatrixMode()" class="text-green-500 hover:text-green-400 transition ml-4 animate-pulse" title="Matrix Mode">
                    <i class="fa-solid fa-bug text-xl"></i>
                </button>
                <button onclick="toggleCheatsheet()" class="text-gray-300 hover:text-white transition ml-4" title="Tra c·ª©u nhanh">
                    <i class="fa-solid fa-book-journal-whills text-xl"></i>
                </button>
                <button id="header-login-btn" onclick="handleHeaderLoginClick()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm transition shadow-lg shadow-blue-500/30">
                    ƒêƒÉng nh·∫≠p
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-8 relative">
            <!-- Content will be injected here by JS -->
        </div>
    </main>

    <!-- AI Chat Widget -->
    <div id="chat-widget" class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
        <!-- Chat Window -->
        <div id="chat-window" class="hidden bg-gray-800 border border-gray-700 w-80 h-96 rounded-2xl shadow-2xl flex flex-col overflow-hidden mb-4 transition-all transform origin-bottom-right fade-in">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="bg-white p-1 rounded-full"><i class="fa-solid fa-robot text-blue-600 text-sm"></i></div>
                    <h3 class="font-bold text-white text-sm">PyBot Assistant</h3>
                </div>
                <button onclick="toggleChat()" class="text-white hover:text-gray-200"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-900 scroll-smooth">
                <div class="flex justify-start">
                    <div class="bg-gray-700 text-gray-200 rounded-2xl rounded-tl-none p-3 max-w-[85%] text-sm shadow-sm">
                        Xin ch√†o! üëã T√¥i l√† AI h·ªó tr·ª£ h·ªçc Python. B·∫°n c√≥ th·∫Øc m·∫Øc g√¨ v·ªÅ b√†i h·ªçc hay code kh√¥ng?
                    </div>
                </div>
            </div>
            <div class="p-3 bg-gray-800 border-t border-gray-700 flex gap-2">
                <input type="text" id="chat-input" class="flex-1 bg-gray-900 border border-gray-600 rounded-full px-4 py-2 text-sm text-white focus:outline-none focus:border-blue-500 placeholder-gray-500" placeholder="H·ªèi g√¨ ƒë√≥..." onkeypress="handleChatKey(event)">
                <button onclick="sendChatMessage()" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full w-9 h-9 flex items-center justify-center transition shadow-lg"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>

        <!-- Toggle Button -->
        <button onclick="toggleChat()" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl transition transform hover:scale-110 hover:rotate-12">
            <i class="fa-solid fa-robot"></i>
        </button>
    </div>

    <!-- Cheatsheet Modal -->
    <div id="cheatsheet-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm fade-in">
        <div class="bg-gray-800 w-11/12 md:w-3/4 h-5/6 rounded-xl border border-gray-700 flex flex-col shadow-2xl">
            <div class="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-900 rounded-t-xl">
                <h3 class="text-xl font-bold text-white"><i class="fa-solid fa-code mr-2 text-yellow-400"></i>Python Cheatsheet</h3>
                <button onclick="toggleCheatsheet()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Card 1 -->
                <div class="bg-gray-700/50 p-4 rounded-lg border border-gray-600">
                    <h4 class="font-bold text-green-400 mb-2">Bi·∫øn & Ki·ªÉu d·ªØ li·ªáu</h4>
                    <pre class="text-xs bg-gray-900 p-2 rounded"><code class="language-python">x = 10        # int
y = 3.14      # float
name = "Py"   # str
is_cool = True # bool</code></pre>
                </div>
                <!-- Card 2 -->
                <div class="bg-gray-700/50 p-4 rounded-lg border border-gray-600">
                    <h4 class="font-bold text-blue-400 mb-2">Chu·ªói (String)</h4>
                    <pre class="text-xs bg-gray-900 p-2 rounded"><code class="language-python">s = "Hello"
print(s[0])   # 'H'
print(len(s)) # 5
print(f"{s} World")</code></pre>
                </div>
                <!-- Card 3 -->
                <div class="bg-gray-700/50 p-4 rounded-lg border border-gray-600">
                    <h4 class="font-bold text-purple-400 mb-2">Danh s√°ch (List)</h4>
                    <pre class="text-xs bg-gray-900 p-2 rounded"><code class="language-python">lst = [1, 2, 3]
lst.append(4)
print(lst[0]) # 1
print(lst[-1]) # Last</code></pre>
                </div>
                <!-- Card 4 -->
                <div class="bg-gray-700/50 p-4 rounded-lg border border-gray-600">
                    <h4 class="font-bold text-yellow-400 mb-2">V√≤ng l·∫∑p (Loops)</h4>
                    <pre class="text-xs bg-gray-900 p-2 rounded"><code class="language-python">for i in range(5):
    print(i)

while x > 0:
    x -= 1</code></pre>
                </div>
                <!-- Card 5 -->
                <div class="bg-gray-700/50 p-4 rounded-lg border border-gray-600">
                    <h4 class="font-bold text-red-400 mb-2">ƒêi·ªÅu ki·ªán (If/Else)</h4>
                    <pre class="text-xs bg-gray-900 p-2 rounded"><code class="language-python">if x > 10:
    print("L·ªõn")
elif x == 10:
    print("B·∫±ng")
else:
    print("Nh·ªè")</code></pre>
                </div>
                <!-- Card 6 -->
                <div class="bg-gray-700/50 p-4 rounded-lg border border-gray-600">
                    <h4 class="font-bold text-pink-400 mb-2">H√†m (Functions)</h4>
                    <pre class="text-xs bg-gray-900 p-2 rounded"><code class="language-python">def hello(name):
    return f"Hi {name}"

print(hello("Dev"))</code></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <script>
        // --- DATA ---
        const lessons = [
            {
                id: 'l1',
                title: 'Gi·ªõi thi·ªáu & C√†i ƒë·∫∑t',
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">Python l√† g√¨?</h3>
                    <p class="mb-4 text-gray-300 leading-relaxed">Python l√† m·ªôt ng√¥n ng·ªØ l·∫≠p tr√¨nh b·∫≠c cao, th√¥ng d·ªãch, h∆∞·ªõng ƒë·ªëi t∆∞·ª£ng v√† ƒëa nƒÉng. N√≥ ƒë∆∞·ª£c thi·∫øt k·∫ø v·ªõi ∆∞u ƒëi·ªÉm m·∫°nh l√† d·ªÖ ƒë·ªçc, d·ªÖ h·ªçc v√† nh·ªõ. Python l√† ng√¥n ng·ªØ c√≥ h√¨nh th·ª©c r·∫•t s√°ng s·ªßa, c·∫•u tr√∫c r√µ r√†ng, thu·∫≠n ti·ªán cho ng∆∞·ªùi m·ªõi h·ªçc l·∫≠p tr√¨nh.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                            <h4 class="font-bold text-lg mb-2 text-green-400">∆Øu ƒëi·ªÉm</h4>
                            <ul class="list-disc list-inside text-gray-400 space-y-1">
                                <li>C√∫ ph√°p ƒë∆°n gi·∫£n, gi·ªëng ti·∫øng Anh.</li>
                                <li>C·ªông ƒë·ªìng h·ªó tr·ª£ c·ª±c l·ªõn.</li>
                                <li>Th∆∞ vi·ªán phong ph√∫ (AI, Web, Data).</li>
                                <li>ƒêa n·ªÅn t·∫£ng (Windows, Mac, Linux).</li>
                            </ul>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                            <h4 class="font-bold text-lg mb-2 text-purple-400">·ª®ng d·ª•ng</h4>
                            <ul class="list-disc list-inside text-gray-400 space-y-1">
                                <li>Ph√°t tri·ªÉn Web (Django, Flask).</li>
                                <li>Khoa h·ªçc d·ªØ li·ªáu & AI (Pandas, PyTorch).</li>
                                <li>T·ª± ƒë·ªông h√≥a (Scripting).</li>
                                <li>Ph√°t tri·ªÉn Game (Pygame).</li>
                            </ul>
                        </div>
                    </div>
                    
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">Ch∆∞∆°ng tr√¨nh ƒë·∫ßu ti√™n</h3>
                    <p class="mb-4 text-gray-300">Trong Python, ƒë·ªÉ in m·ªôt d√≤ng ch·ªØ ra m√†n h√¨nh, ch√∫ng ta d√πng h√†m <code>print()</code>.</p>
                `,
                code: `print("Xin ch√†o, Python!")\nprint("T√¥i ƒëang h·ªçc l·∫≠p tr√¨nh.")`,
                output: `Xin ch√†o, Python!\nT√¥i ƒëang h·ªçc l·∫≠p tr√¨nh.`
            },
            {
                id: 'l2',
                title: 'Bi·∫øn & Ki·ªÉu d·ªØ li·ªáu',
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">Bi·∫øn (Variables)</h3>
                    <p class="mb-4 text-gray-300">Bi·∫øn gi·ªëng nh∆∞ m·ªôt c√°i h·ªôp ch·ª©a d·ªØ li·ªáu. Trong Python, b·∫°n kh√¥ng c·∫ßn khai b√°o ki·ªÉu d·ªØ li·ªáu tr∆∞·ªõc, Python s·∫Ω t·ª± hi·ªÉu.</p>
                    
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">C√°c ki·ªÉu d·ªØ li·ªáu c∆° b·∫£n</h3>
                    <ul class="list-disc list-inside text-gray-300 mb-6 space-y-2">
                        <li><code class="text-yellow-400">int</code>: S·ªë nguy√™n (v√≠ d·ª•: 5, 100, -10).</li>
                        <li><code class="text-yellow-400">float</code>: S·ªë th·ª±c (v√≠ d·ª•: 3.14, 2.5).</li>
                        <li><code class="text-green-400">str</code>: Chu·ªói k√Ω t·ª± (v√≠ d·ª•: "Hello").</li>
                        <li><code class="text-purple-400">bool</code>: Logic (True ho·∫∑c False).</li>
                    </ul>
                `,
                code: `# Khai b√°o bi·∫øn
ten = "Nguy·ªÖn VƒÉn A"  # String
tuoi = 25             # Integer
chieu_cao = 1.75      # Float
dang_hoc = True       # Boolean

print(ten)
print(type(tuoi))     # Ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu`,
                output: `Nguy·ªÖn VƒÉn A\n<class 'int'>`
            },
            {
                id: 'l3',
                title: 'C·∫•u tr√∫c ƒëi·ªÅu ki·ªán (If/Else)',
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">C√¢u l·ªánh If...Else</h3>
                    <p class="mb-4 text-gray-300">D√πng ƒë·ªÉ ra quy·∫øt ƒë·ªãnh. N·∫øu ƒëi·ªÅu ki·ªán ƒë√∫ng th√¨ l√†m vi·ªác A, ng∆∞·ª£c l·∫°i l√†m vi·ªác B.</p>
                    <p class="mb-4 text-gray-300">L∆∞u √Ω quan tr·ªçng: Python s·ª≠ d·ª•ng <strong>th·ª•t ƒë·∫ßu d√≤ng (indentation)</strong> ƒë·ªÉ x√°c ƒë·ªãnh kh·ªëi l·ªánh thay v√¨ d·∫•u ngo·∫∑c nh·ªçn {}.</p>
                `,
                code: `diem_so = 8.5

if diem_so >= 9.0:
    print("Xu·∫•t s·∫Øc")
elif diem_so >= 7.0:
    print("Kh√° gi·ªèi")
else:
    print("C·∫ßn c·ªë g·∫Øng h∆°n")`,
                output: `Kh√° gi·ªèi`
            },
            {
                id: 'l4',
                title: 'V√≤ng l·∫∑p (Loops)',
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">V√≤ng l·∫∑p For</h3>
                    <p class="mb-4 text-gray-300">D√πng ƒë·ªÉ l·∫∑p qua m·ªôt danh s√°ch ho·∫∑c m·ªôt kho·∫£ng s·ªë nh·∫•t ƒë·ªãnh.</p>
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">V√≤ng l·∫∑p While</h3>
                    <p class="mb-4 text-gray-300">Ch·∫°y li√™n t·ª•c mi·ªÖn l√† ƒëi·ªÅu ki·ªán c√≤n ƒë√∫ng.</p>
                `,
                code: `# L·∫∑p qua range
print("ƒê·∫øm s·ªë:")
for i in range(1, 4):
    print(i)

# L·∫∑p qua danh s√°ch
trai_cay = ["T√°o", "Chu·ªëi", "Cam"]
print("\nDanh s√°ch:")
for qua in trai_cay:
    print(qua)`,
                output: `ƒê·∫øm s·ªë:\n1\n2\n3\n\nDanh s√°ch:\nT√°o\nChu·ªëi\nCam`
            },
            {
                id: 'l5',
                title: 'V·∫Ω bi·ªÉu ƒë·ªì (Matplotlib)',
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">Matplotlib l√† g√¨?</h3>
                    <p class="mb-4 text-gray-300">Matplotlib l√† th∆∞ vi·ªán v·∫Ω ƒë·ªì th·ªã 2D ph·ªï bi·∫øn nh·∫•t c·ªßa Python. N√≥ gi√∫p tr·ª±c quan h√≥a d·ªØ li·ªáu th√†nh c√°c bi·ªÉu ƒë·ªì ƒë∆∞·ªùng, c·ªôt, tr√≤n, v.v.</p>
                    
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">V√≠ d·ª• c∆° b·∫£n</h3>
                    <p class="mb-4 text-gray-300">D∆∞·ªõi ƒë√¢y l√† code v·∫Ω m·ªôt bi·ªÉu ƒë·ªì ƒë∆∞·ªùng ƒë∆°n gi·∫£n bi·ªÉu di·ªÖn h√†m b·∫≠c 2 ($y = x^2$).</p>
                    <p class="mb-4 text-yellow-400 text-sm"><i class="fa-solid fa-triangle-exclamation"></i> L∆∞u √Ω: L·∫ßn ƒë·∫ßu ch·∫°y c√≥ th·ªÉ m·∫•t v√†i gi√¢y ƒë·ªÉ t·∫£i th∆∞ vi·ªán.</p>
                `,
                code: `import matplotlib.pyplot as plt

x = [1, 2, 3, 4, 5]
y = [1, 4, 9, 16, 25]

plt.plot(x, y, marker='o', linestyle='--')
plt.title("Bi·ªÉu ƒë·ªì v√≠ d·ª•")
plt.xlabel("Tr·ª•c X")
plt.ylabel("Tr·ª•c Y")
plt.grid(True)

print("ƒêang v·∫Ω bi·ªÉu ƒë·ªì...")
plt.show()
print("Ho√†n t·∫•t!")`,
                output: `(Bi·ªÉu ƒë·ªì s·∫Ω hi·ªán ·ªü ƒë√¢y)`
            },
            {
                id: 'l6',
                title: 'X·ª≠ l√Ω s·ªë v·ªõi NumPy',
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">Gi·ªõi thi·ªáu NumPy</h3>
                    <p class="mb-4 text-gray-300">NumPy (Numerical Python) l√† th∆∞ vi·ªán c·ªët l√µi cho t√≠nh to√°n khoa h·ªçc trong Python. N√≥ cung c·∫•p m·ªôt ƒë·ªëi t∆∞·ª£ng m·∫£ng ƒëa chi·ªÅu hi·ªáu su·∫•t cao v√† c√°c c√¥ng c·ª• ƒë·ªÉ l√†m vi·ªác v·ªõi c√°c m·∫£ng n√†y.</p>
                    <p class="mb-4 text-gray-300">So v·ªõi List c·ªßa Python, m·∫£ng NumPy nhanh h∆°n, t·ªën √≠t b·ªô nh·ªõ h∆°n v√† ti·ªán l·ª£i h∆°n cho c√°c ph√©p to√°n s·ªë h·ªçc.</p>
                    
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">V·∫Ω ƒë·ªì th·ªã h√†m s·ªë</h3>
                    <p class="mb-4 text-gray-300">H√£y th·ª≠ d√πng NumPy ƒë·ªÉ t·∫°o ra d·ªØ li·ªáu cho h√†m sin v√† cos, sau ƒë√≥ d√πng Matplotlib ƒë·ªÉ v·∫Ω ch√∫ng.</p>
                `,
                code: `import numpy as np
import matplotlib.pyplot as plt

# T·∫°o 100 ƒëi·ªÉm d·ªØ li·ªáu t·ª´ 0 ƒë·∫øn 2*PI
x = np.linspace(0, 2 * np.pi, 100)
y_sin = np.sin(x)
y_cos = np.cos(x)

print("V·∫Ω ƒë·ªì th·ªã h√†m sin v√† cos...")
plt.plot(x, y_sin, label='sin(x)')
plt.plot(x, y_cos, label='cos(x)')
plt.title("ƒê·ªì th·ªã Sin v√† Cos")
plt.legend()
plt.grid(True)
plt.show()`,
                output: `(Bi·ªÉu ƒë·ªì s·∫Ω hi·ªán ·ªü ƒë√¢y)`
            },
            {
                id: 'l7',
                title: 'Dictionary & Set',
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">Dictionary (T·ª´ ƒëi·ªÉn)</h3>
                    <p class="mb-4 text-gray-300">L∆∞u tr·ªØ d·ªØ li·ªáu d·∫°ng <code>key: value</code>. R·∫•t gi·ªëng danh b·∫° ƒëi·ªán tho·∫°i (T√™n -> S·ªë).</p>
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">Set (T·∫≠p h·ª£p)</h3>
                    <p class="mb-4 text-gray-300">T·∫≠p h·ª£p c√°c ph·∫ßn t·ª≠ kh√¥ng tr√πng l·∫∑p v√† kh√¥ng c√≥ th·ª© t·ª±.</p>
                `,
                code: `# Dictionary
sinh_vien = {
    "ten": "Nam",
    "tuoi": 20,
    "diem": 9.5
}
print(f"T√™n: {sinh_vien['ten']}, ƒêi·ªÉm: {sinh_vien['diem']}")

# Set
so_thich = {"Code", "Game", "Code", "Nh·∫°c"}
print(f"S·ªü th√≠ch (ƒë√£ l·ªçc tr√πng): {so_thich}")`,
                output: `T√™n: Nam, ƒêi·ªÉm: 9.5\nS·ªü th√≠ch (ƒë√£ l·ªçc tr√πng): {'Game', 'Nh·∫°c', 'Code'}`
            },
            {
                id: 'l8',
                title: 'H√†m (Functions) N√¢ng cao',
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">T·∫°i sao c·∫ßn h√†m?</h3>
                    <p class="mb-4 text-gray-300">H√†m gi√∫p chia nh·ªè ch∆∞∆°ng tr√¨nh th√†nh c√°c kh·ªëi code c√≥ th·ªÉ t√°i s·ª≠ d·ª•ng.</p>
                    <p class="mb-4 text-gray-300">C√∫ ph√°p: <code>def ten_ham(tham_so):</code></p>
                `,
                code: `def tinh_tong(*args):
    """H√†m t√≠nh t·ªïng kh√¥ng gi·ªõi h·∫°n s·ªë l∆∞·ª£ng tham s·ªë"""
    tong = 0
    for so in args:
        tong += so
    return tong

print(tinh_tong(1, 2))
print(tinh_tong(1, 2, 3, 4, 5, 10))`,
                output: `3\n25`
            },
            {
                id: 'l9',
                title: 'X·ª≠ l√Ω l·ªói (Try/Except)',
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">Try...Except</h3>
                    <p class="mb-4 text-gray-300">Khi code ch·∫°y g·∫∑p l·ªói, ch∆∞∆°ng tr√¨nh th∆∞·ªùng s·∫Ω d·ª´ng l·∫°i (crash). D√πng <code>try...except</code> ƒë·ªÉ "b·∫Øt" l·ªói v√† x·ª≠ l√Ω n√≥ nh·∫π nh√†ng.</p>
                `,
                code: `try:
    so = int(input("Nh·∫≠p s·ªë chia: "))
    ket_qua = 100 / so
    print(f"100 chia {so} b·∫±ng {ket_qua}")
except ValueError:
    print("L·ªói: B·∫°n ph·∫£i nh·∫≠p s·ªë!")
except ZeroDivisionError:
    print("L·ªói: Kh√¥ng th·ªÉ chia cho 0!")
print("Ch∆∞∆°ng tr√¨nh v·∫´n ti·∫øp t·ª•c ch·∫°y...")`,
                output: `(Th·ª≠ nh·∫≠p 0 ho·∫∑c ch·ªØ c√°i ƒë·ªÉ xem l·ªói)`
            },
            {
                id: 'l10',
                title: 'Mini Project: ƒêo√°n s·ªë',
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-blue-400">Game ƒêo√°n S·ªë</h3>
                    <p class="mb-4 text-gray-300">S·ª≠ d·ª•ng th∆∞ vi·ªán <code>random</code> v√† v√≤ng l·∫∑p <code>while</code> ƒë·ªÉ t·∫°o m·ªôt tr√≤ ch∆°i ƒë∆°n gi·∫£n.</p>
                    <p class="mb-4 text-gray-300">M√°y t√≠nh s·∫Ω nghƒ© ra m·ªôt s·ªë t·ª´ 1 ƒë·∫øn 10, b·∫°n h√£y ƒëo√°n xem ƒë√≥ l√† s·ªë m·∫•y!</p>
                `,
                code: `import random

bi_mat = random.randint(1, 10)
print("M√°y ƒë√£ nghƒ© ra m·ªôt s·ªë t·ª´ 1 ƒë·∫øn 10.")

doan = int(input("B·∫°n ƒëo√°n s·ªë m·∫•y? "))

if doan == bi_mat:
    print("Ch√∫c m·ª´ng! B·∫°n ƒëo√°n ƒë√∫ng r·ªìi! üéâ")
else:
    print(f"Sai r·ªìi, ƒë√°p √°n l√† {bi_mat}. Th·ª≠ l·∫°i nh√©!")`,
                output: `(Ch·∫°y ƒë·ªÉ ch∆°i game)`
            }
        ];

        const quizzes = [
            {
                question: "H√†m n√†o d√πng ƒë·ªÉ in d·ªØ li·ªáu ra m√†n h√¨nh trong Python?",
                options: ["echo()", "console.log()", "print()", "write()"],
                correct: 2
            },
            {
                question: "ƒê√¢u l√† c√°ch khai b√°o bi·∫øn ƒë√∫ng?",
                options: ["int x = 5;", "var x = 5;", "x = 5", "dim x as integer"],
                correct: 2
            },
            {
                question: "K·∫øt qu·∫£ c·ªßa 10 % 3 l√† bao nhi√™u?",
                options: ["3", "1", "3.33", "0"],
                correct: 1
            },
            {
                question: "Danh s√°ch (List) trong Python ƒë∆∞·ª£c bao quanh b·ªüi d·∫•u g√¨?",
                options: ["( )", "{ }", "[ ]", "< >"],
                correct: 2
            },
            {
                question: "ƒê·ªÉ th√™m m·ªôt ph·∫ßn t·ª≠ v√†o cu·ªëi List, ta d√πng h√†m n√†o?",
                options: ["add()", "append()", "insert()", "push()"],
                correct: 1
            },
            {
                question: "T·ª´ kh√≥a n√†o d√πng ƒë·ªÉ ƒë·ªãnh nghƒ©a h√†m?",
                options: ["func", "function", "def", "define"],
                correct: 2
            }
        ];

        const flashcardsData = [
            { term: "print()", def: "H√†m d√πng ƒë·ªÉ xu·∫•t d·ªØ li·ªáu ra m√†n h√¨nh console." },
            { term: "len()", def: "H√†m tr·∫£ v·ªÅ ƒë·ªô d√†i c·ªßa chu·ªói, danh s√°ch, ho·∫∑c tuple." },
            { term: "input()", def: "H√†m t·∫°m d·ª´ng ch∆∞∆°ng tr√¨nh ƒë·ªÉ ch·ªù ng∆∞·ªùi d√πng nh·∫≠p li·ªáu t·ª´ b√†n ph√≠m." },
            { term: "int", def: "Ki·ªÉu d·ªØ li·ªáu s·ªë nguy√™n (Integer). V√≠ d·ª•: 1, 100, -5." },
            { term: "float", def: "Ki·ªÉu d·ªØ li·ªáu s·ªë th·ª±c (c√≥ d·∫•u ch·∫•m ƒë·ªông). V√≠ d·ª•: 3.14, -0.01." },
            { term: "str", def: "Ki·ªÉu d·ªØ li·ªáu chu·ªói k√Ω t·ª± (String). ƒê∆∞·ª£c bao quanh b·ªüi d·∫•u nh√°y ƒë∆°n ho·∫∑c k√©p." },
            { term: "bool", def: "Ki·ªÉu d·ªØ li·ªáu Logic (Boolean). Ch·ªâ c√≥ 2 gi√° tr·ªã: True ho·∫∑c False." },
            { term: "list", def: "Danh s√°ch c√°c ph·∫ßn t·ª≠ c√≥ th·ª© t·ª±, c√≥ th·ªÉ thay ƒë·ªïi (mutable). C√∫ ph√°p: [1, 2, 3]." },
            { term: "tuple", def: "Danh s√°ch c√°c ph·∫ßn t·ª≠ c√≥ th·ª© t·ª±, KH√îNG th·ªÉ thay ƒë·ªïi (immutable). C√∫ ph√°p: (1, 2, 3)." },
            { term: "dict", def: "T·ª´ ƒëi·ªÉn l∆∞u tr·ªØ d·ªØ li·ªáu d·∫°ng c·∫∑p Key: Value. C√∫ ph√°p: {'name': 'Py', 'age': 3}." },
            { term: "set", def: "T·∫≠p h·ª£p c√°c ph·∫ßn t·ª≠ KH√îNG c√≥ th·ª© t·ª± v√† KH√îNG tr√πng l·∫∑p. C√∫ ph√°p: {1, 2, 3}." },
            { term: "if / elif / else", def: "C√°c t·ª´ kh√≥a d√πng cho c·∫•u tr√∫c ƒëi·ªÅu ki·ªán (r·∫Ω nh√°nh)." },
            { term: "for loop", def: "V√≤ng l·∫∑p d√πng ƒë·ªÉ duy·ªát qua m·ªôt t·∫≠p h·ª£p (list, string, range...)." },
            { term: "while loop", def: "V√≤ng l·∫∑p ch·∫°y li√™n t·ª•c mi·ªÖn l√† ƒëi·ªÅu ki·ªán ki·ªÉm tra c√≤n l√† True." },
            { term: "break", def: "L·ªánh d√πng ƒë·ªÉ tho√°t kh·ªèi v√≤ng l·∫∑p ngay l·∫≠p t·ª©c." },
            { term: "continue", def: "L·ªánh b·ªè qua l·∫ßn l·∫∑p hi·ªán t·∫°i v√† chuy·ªÉn sang l·∫ßn l·∫∑p ti·∫øp theo." },
            { term: "def", def: "T·ª´ kh√≥a d√πng ƒë·ªÉ ƒë·ªãnh nghƒ©a m·ªôt h√†m (function)." },
            { term: "return", def: "L·ªánh d√πng ƒë·ªÉ tr·∫£ v·ªÅ k·∫øt qu·∫£ t·ª´ m·ªôt h√†m v√† k·∫øt th√∫c h√†m ƒë√≥." },
            { term: "import", def: "L·ªánh d√πng ƒë·ªÉ n·∫°p m·ªôt th∆∞ vi·ªán (module) v√†o ch∆∞∆°ng tr√¨nh." },
            { term: "try / except", def: "C·∫•u tr√∫c d√πng ƒë·ªÉ b·∫Øt v√† x·ª≠ l√Ω l·ªói (ngo·∫°i l·ªá) ƒë·ªÉ ch∆∞∆°ng tr√¨nh kh√¥ng b·ªã crash." }
        ];

        const puzzlesData = [
            {
                id: 'p1',
                title: 'ƒê·ªïi ch·ªó hai bi·∫øn',
                desc: 'S·∫Øp x·∫øp c√°c d√≤ng code ƒë·ªÉ ƒë·ªïi gi√° tr·ªã c·ªßa a v√† b cho nhau (d√πng bi·∫øn t·∫°m).',
                correctLines: ["a = 5", "b = 10", "temp = a", "a = b", "b = temp", "print(a, b)"]
            },
            {
                id: 'p2',
                title: 'Ki·ªÉm tra s·ªë ch·∫µn',
                desc: 'Ho√†n thi·ªán h√†m ki·ªÉm tra xem m·ªôt s·ªë n c√≥ ph·∫£i l√† s·ªë ch·∫µn hay kh√¥ng.',
                correctLines: ["def kiem_tra_chan(n):", "    if n % 2 == 0:", "        return True", "    else:", "        return False", "print(kiem_tra_chan(4))"]
            },
            {
                id: 'p3',
                title: 'T√≠nh t·ªïng t·ª´ 1 ƒë·∫øn 5',
                desc: 'S·ª≠ d·ª•ng v√≤ng l·∫∑p ƒë·ªÉ t√≠nh t·ªïng c√°c s·ªë.',
                correctLines: ["tong = 0", "for i in range(1, 6):", "    tong = tong + i", "print(tong)"]
            }
        ];

        const typingSnippets = [
            { lang: 'Python', code: 'print("Hello World")' },
            { lang: 'Python', code: 'def sum(a, b):\n    return a + b' },
            { lang: 'Python', code: 'for i in range(10):\n    if i % 2 == 0:\n        print(i)' },
            { lang: 'Python', code: 'numbers = [1, 2, 3, 4, 5]\nsquared = [x**2 for x in numbers]\nprint(squared)' },
            { lang: 'Python', code: 'import random\n\nsecret = random.randint(1, 100)\nprint(f"Secret is {secret}")' },
            { lang: 'Python', code: 'class Dog:\n    def __init__(self, name):\n        self.name = name\n\n    def bark(self):\n        print("Woof!")' },
            { lang: 'Python', code: 'try:\n    x = 1 / 0\nexcept ZeroDivisionError:\n    print("Error!")' },
            { lang: 'Python', code: 'data = {"name": "Py", "age": 30}\nfor k, v in data.items():\n    print(f"{k}: {v}")' }
        ];

        const codeSnippetsData = [
            { title: "ƒê·∫£o ng∆∞·ª£c chu·ªói", desc: "C√°ch nhanh nh·∫•t ƒë·ªÉ ƒë·∫£o ng∆∞·ª£c m·ªôt chu·ªói.", code: "s = 'Hello'\nreversed_s = s[::-1]\nprint(reversed_s) # olleH" },
            { title: "Ki·ªÉm tra s·ªë nguy√™n t·ªë", desc: "H√†m ki·ªÉm tra m·ªôt s·ªë c√≥ ph·∫£i l√† s·ªë nguy√™n t·ªë kh√¥ng.", code: "def is_prime(n):\n    if n < 2: return False\n    for i in range(2, int(n**0.5) + 1):\n        if n % i == 0: return False\n    return True" },
            { title: "Fibonacci (ƒê·ªá quy)", desc: "T√¨m s·ªë Fibonacci th·ª© n d√πng ƒë·ªá quy.", code: "def fib(n):\n    if n <= 1: return n\n    return fib(n-1) + fib(n-2)" },
            { title: "ƒê·ªçc file an to√†n", desc: "S·ª≠ d·ª•ng with open ƒë·ªÉ t·ª± ƒë·ªông ƒë√≥ng file.", code: "with open('data.txt', 'r', encoding='utf-8') as f:\n    content = f.read()\n    print(content)" },
            { title: "List Comprehension", desc: "T·∫°o list m·ªõi t·ª´ list c≈© c·ª±c ng·∫Øn g·ªçn.", code: "numbers = [1, 2, 3, 4, 5]\neven_squares = [x**2 for x in numbers if x % 2 == 0]\nprint(even_squares) # [4, 16]" },
            { title: "G·ª≠i HTTP Request", desc: "D√πng th∆∞ vi·ªán requests (c·∫ßn c√†i ƒë·∫∑t).", code: "import requests\nresponse = requests.get('https://api.github.com')\nprint(response.status_code)" },
            { title: "Lambda Function", desc: "H√†m v√¥ danh ng·∫Øn g·ªçn.", code: "add = lambda x, y: x + y\nprint(add(5, 3)) # 8" },
            { title: "ƒê·∫øm ph·∫ßn t·ª≠ (Counter)", desc: "ƒê·∫øm s·ªë l·∫ßn xu·∫•t hi·ªán trong list.", code: "from collections import Counter\nlst = ['a', 'b', 'a', 'c', 'b', 'a']\nprint(Counter(lst))" },
            { title: "H·ª£p nh·∫•t Dictionary", desc: "G·ªôp 2 dict th√†nh 1 (Python 3.9+).", code: "d1 = {'a': 1}\nd2 = {'b': 2}\nmerged = d1 | d2\nprint(merged)" },
            { title: "ƒêo th·ªùi gian ch·∫°y", desc: "T√≠nh th·ªùi gian th·ª±c thi code.", code: "import time\nstart = time.time()\n# Code c·∫ßn ƒëo\nend = time.time()\nprint(f'Time: {end - start}s')" }
        ];

        const bossesData = [
            { id: 'b1', name: 'Bug Nh·ªè', hp: 30, maxHp: 30, icon: 'fa-bug', color: 'text-green-400', bg: 'bg-green-900/20', desc: 'Qu√°i v·∫≠t nh·∫≠p m√¥n. Ch·ªâ c·∫ßn bi·∫øt print() l√† th·∫Øng.', xpReward: 50 },
            { id: 'b2', name: 'V√≤ng L·∫∑p V√¥ T·∫≠n', hp: 60, maxHp: 60, icon: 'fa-spin fa-arrows-spin', color: 'text-orange-400', bg: 'bg-orange-900/20', desc: 'N√≥ s·∫Ω quay b·∫°n ch√≥ng m·∫∑t. C·∫ßn ki·∫øn th·ª©c v·ªØng v·ªÅ Loop.', xpReward: 100 },
            { id: 'b3', name: 'Tr√πm Cu·ªëi Syntax', hp: 100, maxHp: 100, icon: 'fa-dragon', color: 'text-red-500', bg: 'bg-red-900/20', desc: 'K·∫ª h·ªßy di·ªát code. Ch·ªâ d√†nh cho Master.', xpReward: 200 }
        ];

        const battleQuestions = [
            { q: "K·∫øt qu·∫£ c·ªßa 3 ** 2 l√†?", a: ["6", "9", "5", "Error"], c: 1, dmg: 10 },
            { q: "len('Python') b·∫±ng m·∫•y?", a: ["5", "6", "7", "4"], c: 1, dmg: 10 },
            { q: "List c√≥ th·ªÉ thay ƒë·ªïi gi√° tr·ªã kh√¥ng?", a: ["C√≥ (Mutable)", "Kh√¥ng (Immutable)", "T√πy tr∆∞·ªùng h·ª£p", "Kh√¥ng bi·∫øt"], c: 0, dmg: 15 },
            { q: "D·∫•u g√¨ d√πng ƒë·ªÉ comment?", a: ["//", "/* */", "#", "<!-- -->"], c: 2, dmg: 10 },
            { q: "H√†m n√†o chuy·ªÉn chu·ªói th√†nh s·ªë nguy√™n?", a: ["str()", "float()", "int()", "char()"], c: 2, dmg: 15 },
            { q: "range(5) t·∫°o ra d√£y s·ªë n√†o?", a: ["1,2,3,4,5", "0,1,2,3,4", "0,1,2,3,4,5", "1,2,3,4"], c: 1, dmg: 20 },
            { q: "To√°n t·ª≠ n√†o l√† 'kh√°c'?", a: ["==", "!=", "<>", "><"], c: 1, dmg: 15 },
            { q: "Index ƒë·∫ßu ti√™n c·ªßa List l√†?", a: ["1", "0", "-1", "null"], c: 1, dmg: 10 }
        ];

        // --- STATE MANAGEMENT ---
        let currentView = 'home';
        // Load completed lessons from localStorage
        let completedLessons = JSON.parse(localStorage.getItem('pymaster_completed')) || [];
        
        // Login State
        let isLoggedIn = localStorage.getItem('pymaster_is_logged_in') === 'true';
        let currentUser = localStorage.getItem('pymaster_username') || 'Kh√°ch';

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderSidebarLessons();
            renderView('home');
            updateProgress();
            initMusic();
            updateHeaderUI();
        });

        // --- RENDERING FUNCTIONS ---
        function filterLessons() {
            const term = document.getElementById('search-lesson').value.toLowerCase();
            renderSidebarLessons(term);
        }

        function renderSidebarLessons(filter = "") {
            const list = document.getElementById('lesson-list');
            const filtered = lessons.filter(l => l.title.toLowerCase().includes(filter));
            
            if (filtered.length === 0) {
                list.innerHTML = '<li class="text-gray-500 text-xs text-center py-4">Kh√¥ng t√¨m th·∫•y b√†i h·ªçc</li>';
                return;
            }

            list.innerHTML = filtered.map((lesson, index) => `
                <li>
                    <button onclick="loadLesson('${lesson.id}')" class="nav-item w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition flex items-center justify-between text-sm text-gray-300 ml-2 border-l-2 border-gray-600 hover:border-blue-500" id="nav-${lesson.id}">
                        <div class="flex items-center">
                            <span class="mr-2 text-xs opacity-50">0${index + 1}</span> ${lesson.title}
                        </div>
                        ${completedLessons.includes(lesson.id) ? '<i class="fa-solid fa-check text-green-500 text-xs"></i>' : ''}
                    </button>
                </li>
            `).join('');
        }

        function setActiveNav(id) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const el = document.getElementById('nav-' + id);
            if (el) el.classList.add('active');
        }

        function renderView(viewName) {
            currentView = viewName;
            const content = document.getElementById('content-area');
            const title = document.getElementById('page-title');
            
            content.innerHTML = ''; // Clear content
            content.className = "flex-1 overflow-y-auto p-8 relative fade-in";

            if (viewName === 'home') {
                setActiveNav('home');
                title.innerText = "T·ªïng quan";
                content.innerHTML = `
                    <div class="max-w-4xl mx-auto text-center pt-10">
                        <div class="mb-8 relative inline-block">
                            <div class="absolute inset-0 bg-blue-500 blur-3xl opacity-20 rounded-full"></div>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c3/Python-logo-notext.svg" alt="Python Logo" class="w-32 h-32 relative z-10 mx-auto drop-shadow-2xl animate-bounce" style="animation-duration: 3s;">
                        </div>
                        <h1 class="text-5xl font-bold text-white mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-green-400">Chinh ph·ª•c Python</h1>
                        <p class="text-xl text-gray-400 mb-10 max-w-2xl mx-auto">
                            N·ªÅn t·∫£ng h·ªçc l·∫≠p tr√¨nh Python t∆∞∆°ng t√°c, mi·ªÖn ph√≠ v√† chi ti·∫øt nh·∫•t. 
                            T·ª´ con s·ªë 0 tr·ªü th√†nh Hero v·ªõi l·ªô tr√¨nh b√†i b·∫£n.
                        </p>
                        <div class="flex justify-center gap-4">
                            <button onclick="renderView('roadmap')" class="px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold text-lg transition transform hover:scale-105 shadow-lg shadow-blue-500/50">
                                B·∫Øt ƒë·∫ßu ngay
                            </button>
                            <button onclick="renderView('exercises')" class="px-8 py-4 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold text-lg transition transform hover:scale-105 border border-gray-600">
                                L√†m b√†i t·∫≠p
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-20 text-left">
                            <div class="p-6 bg-gray-800/50 rounded-xl border border-gray-700 hover:border-blue-500 transition">
                                <i class="fa-solid fa-book-open text-3xl text-blue-400 mb-4"></i>
                                <h3 class="text-xl font-bold text-white mb-2">L√Ω thuy·∫øt chi ti·∫øt</h3>
                                <p class="text-gray-400">Gi·∫£i th√≠ch c·∫∑n k·∫Ω, d·ªÖ hi·ªÉu v·ªõi v√≠ d·ª• th·ª±c t·∫ø.</p>
                            </div>
                            <div class="p-6 bg-gray-800/50 rounded-xl border border-gray-700 hover:border-green-500 transition">
                                <i class="fa-solid fa-laptop-code text-3xl text-green-400 mb-4"></i>
                                <h3 class="text-xl font-bold text-white mb-2">Code tr·ª±c ti·∫øp</h3>
                                <p class="text-gray-400">Tr√¨nh bi√™n t·∫≠p code gi·∫£ l·∫≠p ngay tr√™n tr√¨nh duy·ªát.</p>
                            </div>
                            <div class="p-6 bg-gray-800/50 rounded-xl border border-gray-700 hover:border-purple-500 transition">
                                <i class="fa-solid fa-road text-3xl text-purple-400 mb-4"></i>
                                <h3 class="text-xl font-bold text-white mb-2">L·ªô tr√¨nh r√µ r√†ng</h3>
                                <p class="text-gray-400">Bi·∫øt r√µ m√¨nh ƒëang ·ªü ƒë√¢u v√† c·∫ßn h·ªçc g√¨ ti·∫øp theo.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (viewName === 'playground') {
                setActiveNav('playground');
                title.innerText = "Playground - S√¢n ch∆°i Code";
                
                // Load saved playground code
                const savedCode = localStorage.getItem('pymaster_playground_code') || '# Vi·∫øt code Python t·ª± do t·∫°i ƒë√¢y...\nprint("Hello World")';

                content.innerHTML = `
                    <div class="flex flex-col h-full fade-in">
                        <div class="bg-blue-900/20 border border-blue-800 p-4 rounded-lg mb-4 flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-blue-400">Ch·∫ø ƒë·ªô t·ª± do</h3>
                                <p class="text-sm text-gray-300">Th·ª≠ nghi·ªám b·∫•t k·ª≥ √Ω t∆∞·ªüng n√†o c·ªßa b·∫°n. Code s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông l∆∞u.</p>
                            </div>
                            <button onclick="runCode('playground')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold transition shadow-lg shadow-green-500/30">
                                <i class="fa-solid fa-play mr-2"></i> Ch·∫°y ngay
                            </button>
                        </div>
                        
                        <div class="flex-1 flex flex-col lg:flex-row gap-6 overflow-hidden">
                            <div class="lg:w-1/2 flex flex-col bg-gray-800 rounded-xl border border-gray-700 overflow-hidden shadow-2xl">
                                <div class="bg-gray-900 px-4 py-2 text-xs font-mono text-gray-400 border-b border-gray-700">playground.py</div>
                                <textarea id="code-editor-playground" class="w-full h-full bg-gray-800 text-gray-100 font-mono p-4 resize-none focus:outline-none bg-transparent" spellcheck="false">${savedCode}</textarea>
                            </div>
                            <div class="lg:w-1/2 flex flex-col bg-black rounded-xl border border-gray-700 overflow-hidden shadow-2xl">
                                <div class="bg-gray-900 px-4 py-2 text-xs font-mono text-gray-500 border-b border-gray-700 uppercase font-bold">Output</div>
                                <pre id="output-playground" class="flex-1 p-4 font-mono text-sm text-green-400 overflow-auto whitespace-pre-wrap">S·∫µn s√†ng th·ª±c thi...</pre>
                            </div>
                        </div>
                    </div>
                `;
                
                // Setup editor logic for playground
                setTimeout(() => {
                    const textarea = document.getElementById('code-editor-playground');
                    if(textarea) {
                        textarea.addEventListener('input', function() {
                            localStorage.setItem('pymaster_playground_code', this.value);
                        });
                        // Re-use the tab/indent logic
                        textarea.addEventListener('keydown', document.getElementById('code-editor-l1')?.onkeydown || function(e){/*Logic duplicated for simplicity in this view*/}); 
                    }
                }, 100);
            } else if (viewName === 'certificate') {
                title.innerText = "Ch·ª©ng ch·ªâ ho√†n th√†nh";
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full fade-in">
                        <div class="bg-white text-gray-900 p-10 rounded-xl shadow-2xl max-w-2xl w-full text-center border-8 border-double border-yellow-500 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                            <i class="fa-solid fa-award text-6xl text-yellow-500 mb-6"></i>
                            <h1 class="text-4xl font-serif font-bold mb-2 uppercase tracking-widest">Ch·ª©ng Ch·ªâ</h1>
                            <p class="text-gray-500 italic mb-8">Ch·ª©ng nh·∫≠n ho√†n th√†nh kh√≥a h·ªçc</p>
                            
                            <h2 class="text-3xl font-bold text-blue-800 mb-6 border-b-2 border-gray-200 pb-4 inline-block px-10">H·ªçc Vi√™n Python</h2>
                            
                            <p class="text-lg mb-8">ƒê√£ xu·∫•t s·∫Øc ho√†n th√†nh to√†n b·ªô l·ªô tr√¨nh <br><strong>Python Master Class</strong></p>
                            
                            <div class="flex justify-between items-end mt-10 w-full px-10">
                                <div class="text-left">
                                    <p class="text-xs text-gray-400 uppercase">Ng√†y c·∫•p</p>
                                    <p class="font-bold">${new Date().toLocaleDateString('vi-VN')}</p>
                                </div>
                                <div class="text-right">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c3/Python-logo-notext.svg" class="w-12 h-12 opacity-50 grayscale hover:grayscale-0 transition">
                                </div>
                            </div>
                        </div>
                        <button onclick="window.print()" class="mt-8 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg flex items-center gap-2">
                            <i class="fa-solid fa-print"></i> In Ch·ª©ng Ch·ªâ
                        </button>
                    </div>
                `;
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
            } else if (viewName === 'roadmap') {
                setActiveNav('roadmap');
                title.innerText = "L·ªô tr√¨nh h·ªçc t·∫≠p";
                content.innerHTML = `
                    <div class="max-w-3xl mx-auto">
                        <div class="relative border-l-4 border-gray-700 ml-6 space-y-12">
                            
                            <!-- Step 1 -->
                            <div class="relative pl-12 group">
                                <div class="absolute -left-3.5 top-2 w-7 h-7 bg-blue-600 rounded-full border-4 border-gray-900 group-hover:scale-125 transition"></div>
                                <h3 class="text-2xl font-bold text-white mb-2">1. Nh·∫≠p m√¥n Python</h3>
                                <p class="text-gray-400 mb-4">L√†m quen v·ªõi c√∫ ph√°p, bi·∫øn, ki·ªÉu d·ªØ li·ªáu v√† c√°c ph√©p to√°n c∆° b·∫£n.</p>
                                <div class="flex gap-2">
                                    <span class="px-3 py-1 bg-gray-800 rounded text-xs text-blue-300 border border-blue-900">Syntax</span>
                                    <span class="px-3 py-1 bg-gray-800 rounded text-xs text-blue-300 border border-blue-900">Variables</span>
                                </div>
                            </div>

                            <!-- Step 2 -->
                            <div class="relative pl-12 group">
                                <div class="absolute -left-3.5 top-2 w-7 h-7 bg-green-600 rounded-full border-4 border-gray-900 group-hover:scale-125 transition"></div>
                                <h3 class="text-2xl font-bold text-white mb-2">2. ƒêi·ªÅu khi·ªÉn lu·ªìng</h3>
                                <p class="text-gray-400 mb-4">H·ªçc c√°ch m√°y t√≠nh ra quy·∫øt ƒë·ªãnh (If/Else) v√† th·ª±c hi·ªán c√¥ng vi·ªác l·∫∑p l·∫°i (Loops).</p>
                                <div class="flex gap-2">
                                    <span class="px-3 py-1 bg-gray-800 rounded text-xs text-green-300 border border-green-900">If/Else</span>
                                    <span class="px-3 py-1 bg-gray-800 rounded text-xs text-green-300 border border-green-900">Loops</span>
                                </div>
                            </div>

                            <!-- Step 3 -->
                            <div class="relative pl-12 group">
                                <div class="absolute -left-3.5 top-2 w-7 h-7 bg-purple-600 rounded-full border-4 border-gray-900 group-hover:scale-125 transition"></div>
                                <h3 class="text-2xl font-bold text-white mb-2">3. C·∫•u tr√∫c d·ªØ li·ªáu & H√†m</h3>
                                <p class="text-gray-400 mb-4">List, Tuple, Dictionary v√† c√°ch vi·∫øt h√†m (Functions) ƒë·ªÉ t√°i s·ª≠ d·ª•ng code.</p>
                            </div>

                            <!-- Step 4 -->
                            <div class="relative pl-12 group">
                                <div class="absolute -left-3.5 top-2 w-7 h-7 bg-yellow-600 rounded-full border-4 border-gray-900 group-hover:scale-125 transition"></div>
                                <h3 class="text-2xl font-bold text-white mb-2">4. H∆∞·ªõng ƒë·ªëi t∆∞·ª£ng (OOP)</h3>
                                <p class="text-gray-400 mb-4">Class, Object, K·∫ø th·ª´a - N·ªÅn t·∫£ng c·ªßa ph·∫ßn m·ªÅm hi·ªán ƒë·∫°i.</p>
                            </div>

                            <!-- Step 5 -->
                            <div class="relative pl-12 group">
                                <div class="absolute -left-3.5 top-2 w-7 h-7 bg-red-600 rounded-full border-4 border-gray-900 group-hover:scale-125 transition"></div>
                                <h3 class="text-2xl font-bold text-white mb-2">5. ·ª®ng d·ª•ng th·ª±c t·∫ø</h3>
                                <p class="text-gray-400 mb-4">Ch·ªçn h∆∞·ªõng ƒëi: Web (Django), Data (Pandas) ho·∫∑c Automation.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (viewName === 'exercises') {
                setActiveNav('exercises');
                title.innerText = "B√†i t·∫≠p tr·∫Øc nghi·ªám";
                renderQuiz(content);
            } else if (viewName === 'flashcards') {
                setActiveNav('flashcards');
                title.innerText = "Flashcards - √în t·∫≠p nhanh";
                renderFlashcards(content);
            } else if (viewName === 'puzzles') {
                setActiveNav('puzzles');
                title.innerText = "X·∫øp h√¨nh Code Logic";
                renderPuzzlesList(content);
            } else if (viewName === 'typing') {
                setActiveNav('typing');
                title.innerText = "Luy·ªán t·ªëc ƒë·ªô g√µ Code";
                renderTypingGame(content);
            } else if (viewName === 'profile') {
                setActiveNav('profile');
                if (isLoggedIn) {
                    title.innerText = "H·ªì s∆° c√° nh√¢n";
                    renderProfile(content);
                } else {
                    title.innerText = "ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω";
                    renderLogin(content);
                }
            } else if (viewName === 'snippets') {
                setActiveNav('snippets');
                title.innerText = "Th∆∞ vi·ªán Code m·∫´u";
                renderSnippets(content);
            } else if (viewName === 'boss') {
                setActiveNav('boss');
                title.innerText = "SƒÉn Boss - ƒê·∫•u tr∆∞·ªùng Code";
                renderBossList(content);
            }
        }

        function loadLesson(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) return;

            setActiveNav(lessonId);
            const title = document.getElementById('page-title');
            title.innerText = lesson.title;

            // Load saved code or default code
            const savedCode = localStorage.getItem(`pymaster_code_${lessonId}`);
            const codeToDisplay = savedCode !== null ? savedCode : lesson.code;

            const content = document.getElementById('content-area');
            content.innerHTML = `
                <div class="flex flex-col lg:flex-row gap-6 h-full fade-in">
                    <!-- Theory Section -->
                    <div class="lg:w-1/2 overflow-y-auto pr-2">
                        <div class="prose prose-invert max-w-none">
                            ${lesson.content}
                        </div>
                        
                        <div class="mt-8 p-4 bg-blue-900/20 border border-blue-800 rounded-lg">
                            <h4 class="font-bold text-blue-400 mb-2"><i class="fa-solid fa-lightbulb"></i> M·∫πo nh·ªè</h4>
                            <button onclick="speakContent()" class="float-right bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs transition">
                                <i class="fa-solid fa-volume-high"></i> ƒê·ªçc b√†i
                            </button>
                            <p class="text-sm text-gray-300">H√£y th·ª≠ thay ƒë·ªïi c√°c gi√° tr·ªã trong ƒëo·∫°n code b√™n ph·∫£i v√† ch·∫°y th·ª≠ ƒë·ªÉ xem k·∫øt qu·∫£ thay ƒë·ªïi nh∆∞ th·∫ø n√†o nh√©!</p>
                        </div>
                    </div>

                    <!-- Code Editor Section -->
                    <div class="lg:w-1/2 flex flex-col bg-gray-800 rounded-xl border border-gray-700 overflow-hidden shadow-2xl">
                        <div class="bg-gray-900 px-4 py-2 flex justify-between items-center border-b border-gray-700">
                            <span class="text-xs font-mono text-gray-400">main.py</span>
                            <div class="flex gap-2">
                                <button onclick="resetCode('${lessonId}')" title="Kh√¥i ph·ª•c code g·ªëc" class="text-gray-400 hover:text-white transition p-1"><i class="fa-solid fa-rotate-left"></i></button>
                                <button onclick="copyCode('${lessonId}')" title="Sao ch√©p" class="text-gray-400 hover:text-white transition p-1"><i class="fa-regular fa-copy"></i></button>
                                <button onclick="downloadCode('${lessonId}')" title="T·∫£i xu·ªëng .py" class="text-gray-400 hover:text-white transition p-1"><i class="fa-solid fa-download"></i></button>
                                <button onclick="runCode('${lessonId}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-bold transition flex items-center gap-2 ml-2">
                                    <i class="fa-solid fa-play"></i> Ch·∫°y
                                </button>
                            </div>
                        </div>
                        <div class="flex-1 relative group">
                            <textarea id="code-editor-${lessonId}" class="w-full h-full bg-gray-800 text-gray-100 font-mono p-4 resize-none focus:outline-none z-10 relative bg-transparent" spellcheck="false">${codeToDisplay}</textarea>
                            <!-- Syntax highlight overlay could go here, but for simplicity we use textarea -->
                        </div>
                        <div class="h-1/3 bg-black border-t border-gray-700 flex flex-col">
                            <div class="px-4 py-1 bg-gray-900 text-xs text-gray-500 uppercase font-bold tracking-wider">Terminal / Output</div>
                            <pre id="output-${lessonId}" class="flex-1 p-4 font-mono text-sm text-green-400 overflow-auto whitespace-pre-wrap">Waiting for execution...</pre>
                        </div>
                    </div>
                </div>
            `;

            // --- C·∫§U H√åNH EDITOR: H·ªó tr·ª£ Tab v√† Auto-indent ---
            const textarea = document.getElementById(`code-editor-${lessonId}`);
            if (textarea) {
                // Auto-save on input
                textarea.addEventListener('input', function() {
                    localStorage.setItem(`pymaster_code_${lessonId}`, this.value);
                });

                textarea.addEventListener('keydown', function(e) {
                    // X·ª≠ l√Ω ph√≠m Tab -> 4 spaces
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        this.value = this.value.substring(0, start) + "    " + this.value.substring(end);
                        this.selectionStart = this.selectionEnd = start + 4;
                    } 
                    // X·ª≠ l√Ω ph√≠m Enter -> Xu·ªëng d√≤ng + Th·ª•t l·ªÅ th√¥ng minh
                    else if (e.key === 'Enter') {
                        e.preventDefault();
                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        const value = this.value;
                        
                        // T√¨m d√≤ng hi·ªán t·∫°i
                        const lastNewLine = value.lastIndexOf('\n', start - 1);
                        const lineStart = lastNewLine + 1;
                        const currentLine = value.substring(lineStart, start);
                        
                        // Gi·ªØ nguy√™n th·ª•t ƒë·∫ßu d√≤ng c·ªßa d√≤ng tr√™n
                        const match = currentLine.match(/^ */);
                        let indent = match ? match[0] : '';
                        
                        // N·∫øu d√≤ng tr√™n k·∫øt th√∫c b·∫±ng ':', th·ª•t th√™m 4 spaces
                        if (currentLine.trim().endsWith(':')) {
                            indent += '    ';
                        }
                        
                        this.value = value.substring(0, start) + '\n' + indent + value.substring(end);
                        this.selectionStart = this.selectionEnd = start + 1 + indent.length;
                    }
                });
            }
            
            // Re-highlight syntax if we were using a static block, 
            // but since we use textarea for editing, we skip Prism on the input for this simple demo.
            // We will highlight static code blocks in theory section.
            Prism.highlightAll();
        }

        // --- HELPER FUNCTIONS ---
        function resetCode(lessonId) {
            if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën kh√¥i ph·ª•c code v·ªÅ m·∫∑c ƒë·ªãnh?")) {
                const lesson = lessons.find(l => l.id === lessonId);
                const textarea = document.getElementById(`code-editor-${lessonId}`);
                if (lesson && textarea) {
                    textarea.value = lesson.code;
                    localStorage.removeItem(`pymaster_code_${lessonId}`);
                }
            }
        }

        function copyCode(lessonId) {
            const textarea = document.getElementById(`code-editor-${lessonId}`);
            if (textarea) {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    alert("ƒê√£ sao ch√©p code!");
                });
            }
        }

        function downloadCode(lessonId) {
            const textarea = document.getElementById(`code-editor-${lessonId}`);
            if (textarea) {
                const blob = new Blob([textarea.value], { type: 'text/x-python' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lesson_${lessonId}.py`;
                a.click();
                window.URL.revokeObjectURL(url);
            }
        }

        // --- MUSIC PLAYER FUNCTIONS ---
        const playlist = [
            { title: "Chill Study", src: "https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3" },
            { title: "Coding Night", src: "https://cdn.pixabay.com/audio/2022/03/15/audio_c8c8a73467.mp3" },
            { title: "Focus Flow", src: "https://cdn.pixabay.com/audio/2022/01/18/audio_d0a13f69d2.mp3" },
            { title: "Rainy Code", src: "https://cdn.pixabay.com/audio/2022/02/22/audio_d1718ab41b.mp3" }
        ];
        let currentTrackIdx = 0;
        let isPlaying = false;

        function initMusic() {
            const audio = document.getElementById('bg-music');
            if(audio) {
                audio.volume = 0.4;
                loadTrack(0, false);
                audio.onended = () => nextTrack();
            }
        }

        function loadTrack(index, autoPlay = true) {
            const audio = document.getElementById('bg-music');
            const nameDisplay = document.getElementById('track-name');
            
            if (index < 0) index = playlist.length - 1;
            if (index >= playlist.length) index = 0;
            
            currentTrackIdx = index;
            audio.src = playlist[currentTrackIdx].src;
            nameDisplay.innerText = playlist[currentTrackIdx].title;
            
            if (autoPlay) {
                audio.play();
                isPlaying = true;
                updateMusicUI();
            }
        }

        function toggleMusic() {
            const audio = document.getElementById('bg-music');
            if (audio.paused) {
                audio.play();
                isPlaying = true;
            } else {
                audio.pause();
                isPlaying = false;
            }
            updateMusicUI();
        }

        function nextTrack() { loadTrack(currentTrackIdx + 1); }
        function prevTrack() { loadTrack(currentTrackIdx - 1); }

        function updateMusicUI() {
            const icon = document.getElementById('music-play-icon');
            const visualizer = document.getElementById('music-visualizer');
            
            if (isPlaying) {
                icon.classList.remove('fa-circle-play');
                icon.classList.add('fa-circle-pause');
                visualizer.classList.add('animate-bounce');
            } else {
                icon.classList.remove('fa-circle-pause');
                icon.classList.add('fa-circle-play');
                visualizer.classList.remove('animate-bounce');
            }
        }

        // --- AI CHATBOT FUNCTIONS ---
        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.classList.toggle('hidden');
            if (!win.classList.contains('hidden')) {
                document.getElementById('chat-input').focus();
            }
        }

        function handleChatKey(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // NgƒÉn Enter xu·ªëng d√≤ng trong input
                sendChatMessage();
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            // Add user message
            addMessage(msg, 'user');
            input.value = '';

            // Show thinking indicator
            const chatBody = document.getElementById('chat-messages');
            const loadingId = 'loading-' + Date.now();
            chatBody.innerHTML += `
                <div id="${loadingId}" class="flex justify-start">
                    <div class="bg-gray-700 text-gray-400 rounded-2xl rounded-tl-none p-3 text-xs italic">
                        <i class="fa-solid fa-circle-notch fa-spin mr-2"></i>PyBot ƒëang t√¨m c√¢u tr·∫£ l·ªùi...
                    </div>
                </div>
            `;
            chatBody.scrollTop = chatBody.scrollHeight;

            // Gi·∫£ l·∫≠p ƒë·ªô tr·ªÖ ƒë·ªÉ t·∫°o c·∫£m gi√°c t·ª± nhi√™n
            setTimeout(() => {
                document.getElementById(loadingId).remove();
                const response = getLocalBotResponse(msg);
                addMessage(response, 'bot');
            }, 600);
        }

        let lastChatTopic = null; // BI·∫æN GHI NH·ªö: L∆∞u l·∫°i ch·ªß ƒë·ªÅ g·∫ßn nh·∫•t

        function getLocalBotResponse(input) {
            input = input.toLowerCase();

            // --- M·ªöI: X·ª≠ l√Ω c√¢u h·ªèi ti·∫øp theo (follow-up) d·ª±a v√†o ng·ªØ c·∫£nh ---
            if (lastChatTopic) {
                if (input.includes('d√πng ƒë·ªÉ l√†m g√¨') || input.includes('d√πng trong tr∆∞·ªùng h·ª£p') || input.includes('khi n√†o d√πng') || input.includes('t√°c d·ª•ng')) {
                    if (keywords[lastChatTopic] && keywords[lastChatTopic].use) {
                        return keywords[lastChatTopic].use;
                    }
                }
                if (input.includes('v√≠ d·ª•') || input.includes('cho v√≠ d·ª•') || input.includes('code m·∫´u')) {
                    if (keywords[lastChatTopic] && keywords[lastChatTopic].example) {
                        const example = keywords[lastChatTopic].example;
                        lastChatTopic = null; // X√≥a b·ªô nh·ªõ sau khi ƒë√£ cho v√≠ d·ª•
                        return example;
                    }
                }
            }
            
            // 1. X√£ giao & Giao ti·∫øp h√†ng ng√†y
            if (input.includes('xin ch√†o') || input.includes('hi') || input.includes('hello') || input.includes('h√™ l√¥') || input.includes('alo') || input.includes('ch√†o')) {
                return "Ch√†o b·∫°n! T√¥i l√† PyBot. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n v·ªÅ Python h√¥m nay?";
            }
            if (input.includes('t·∫°m bi·ªát') || input.includes('bye') || input.includes('h·∫πn g·∫∑p l·∫°i')) {
                return "T·∫°m bi·ªát! H·∫πn g·∫∑p l·∫°i b·∫°n trong b√†i h·ªçc ti·∫øp theo nh√©.";
            }
            if (input.includes('c·∫£m ∆°n') || input.includes('thanks') || input.includes('thank you')) {
                return "Kh√¥ng c√≥ chi! R·∫•t vui ƒë∆∞·ª£c gi√∫p ƒë·ª° b·∫°n.";
            }
            if (input.includes('b·∫°n t√™n g√¨') || input.includes('t√™n b·∫°n l√† g√¨')) {
                return "T√¥i l√† PyBot, tr·ª£ l√Ω ·∫£o h·ªó tr·ª£ h·ªçc l·∫≠p tr√¨nh Python.";
            }
            if (input.includes('kh·ªèe kh√¥ng') || input.includes('b·∫°n th·∫ø n√†o')) {
                return "T√¥i l√† ph·∫ßn m·ªÅm n√™n l√∫c n√†o c≈©ng 'kh·ªèe' 100% nƒÉng l∆∞·ª£ng! C·∫£m ∆°n b·∫°n ƒë√£ h·ªèi thƒÉm.";
            }
            if (input.includes('ai t·∫°o ra b·∫°n') || input.includes('b·∫°n ƒë·∫øn t·ª´ ƒë√¢u')) {
                return "T√¥i ƒë∆∞·ª£c t·∫°o ra b·ªüi m·ªôt l·∫≠p tr√¨nh vi√™n ƒëam m√™ Python (ch√≠nh l√† b·∫°n ƒëang ph√°t tri·ªÉn t√¥i ƒë·∫•y!).";
            }
            if (input.includes('gi√∫p t√¥i') || input.includes('help') || input.includes('c·ª©u')) {
                return "T√¥i s·∫µn s√†ng! B·∫°n ƒëang g·∫∑p kh√≥ khƒÉn ·ªü ph·∫ßn n√†o? Bi·∫øn, v√≤ng l·∫∑p hay h√†m?";
            }
            if (input.includes('ch√†o bu·ªïi s√°ng')) {
                return "Ch√†o bu·ªïi s√°ng! N·∫°p nƒÉng l∆∞·ª£ng v√† code v√†i d√≤ng Python kh·ªüi ƒë·ªông ng√†y m·ªõi n√†o!";
            }
            if (input.includes('ch√†o bu·ªïi t·ªëi') || input.includes('ch√∫c ng·ªß ngon')) {
                return "Ch√†o bu·ªïi t·ªëi! Nh·ªõ ngh·ªâ ng∆°i ƒëi·ªÅu ƒë·ªô nh√©, ƒë·ª´ng code khuya qu√°.";
            }
            if (input.includes('th√¥ng minh') || input.includes('gi·ªèi') || input.includes('tuy·ªát') || input.includes('x·ªãn')) {
                return "C·∫£m ∆°n b·∫°n qu√° khen! T√¥i v·∫´n ƒëang h·ªçc h·ªèi th√™m t·ª´ b·∫°n m·ªói ng√†y.";
            }
            if (input.includes('ngu') || input.includes('d·ªët') || input.includes('k√©m')) {
                return "Xin l·ªói n·∫øu t√¥i l√†m b·∫°n th·∫•t v·ªçng. T√¥i v·∫´n ƒëang trong qu√° tr√¨nh ph√°t tri·ªÉn, h√£y ki√™n nh·∫´n v·ªõi t√¥i nh√©!";
            }
            if (input.includes('l√†m g√¨') || input.includes('ch·ª©c nƒÉng')) {
                return "T√¥i c√≥ th·ªÉ gi·∫£i ƒë√°p th·∫Øc m·∫Øc v·ªÅ Python, t√¨m b√†i h·ªçc gi√∫p b·∫°n, ho·∫∑c ƒë∆°n gi·∫£n l√† tr√≤ chuy·ªán cho ƒë·ª° bu·ªìn khi debug!";
            }
            
            // --- M·ªöI: C·∫£m x√∫c & ƒê·ªông vi√™n ---
            if (input.includes('ch√°n') || input.includes('n·∫£n') || input.includes('m·ªát')) {
                return "ƒê·ª´ng b·ªè cu·ªôc! L·∫≠p tr√¨nh ƒë√¥i khi r·∫•t kh√≥, nh∆∞ng c·∫£m gi√°c khi code ch·∫°y th√†nh c√¥ng r·∫•t tuy·ªát v·ªùi. H√£y ngh·ªâ ng∆°i m·ªôt ch√∫t r·ªìi quay l·∫°i nh√©.";
            }
            if (input.includes('kh√≥ qu√°') || input.includes('kh√¥ng hi·ªÉu')) {
                return "M·ªçi th·ª© ƒë·ªÅu kh√≥ khi m·ªõi b·∫Øt ƒë·∫ßu. B·∫°n h√£y th·ª≠ chia nh·ªè v·∫•n ƒë·ªÅ ra, ho·∫∑c xem l·∫°i c√°c b√†i h·ªçc c∆° b·∫£n. T√¥i tin b·∫°n l√†m ƒë∆∞·ª£c!";
            }
            if (input.includes('vui') || input.includes('h·∫°nh ph√∫c')) {
                return "Nghe v·∫≠y t√¥i c≈©ng vui l√¢y! C√≥ chuy·ªán g√¨ vui k·ªÉ t√¥i nghe v·ªõi?";
            }

            // --- M·ªöI: Gi·∫£i tr√≠ ---
            if (input.includes('k·ªÉ chuy·ªán c∆∞·ªùi') || input.includes('truy·ªán c∆∞·ªùi')) {
                const jokes = [
                    "T·∫°i sao l·∫≠p tr√¨nh vi√™n kh√¥ng th√≠ch thi√™n nhi√™n? V√¨ n√≥ c√≥ qu√° nhi·ªÅu bugs.",
                    "0 l√† false v√† 1 l√† true, ƒë√∫ng kh√¥ng? 1.",
                    "M·ªôt l·∫≠p tr√¨nh vi√™n ƒëi mua s·ªØa. V·ª£ d·∫∑n: 'Mua 1 chai s·ªØa, n·∫øu c√≥ tr·ª©ng th√¨ mua 10'. Anh ta v·ªÅ nh√† v·ªõi 10 chai s·ªØa v√¨ c·ª≠a h√†ng c√≥ tr·ª©ng.",
                    "L·∫≠p tr√¨nh vi√™n: Ng∆∞·ªùi gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ b·∫°n kh√¥ng bi·∫øt l√† m√¨nh g·∫∑p ph·∫£i theo c√°ch b·∫°n kh√¥ng hi·ªÉu."
                ];
                return jokes[Math.floor(Math.random() * jokes.length)];
            }
            if (input.includes('h√°t') || input.includes('nh·∫°c')) {
                return "T√¥i kh√¥ng bi·∫øt h√°t, nh∆∞ng t√¥i c√≥ th·ªÉ ph√°t nh·∫°c Lofi cho b·∫°n nghe. H√£y nh√¨n l√™n thanh menu nh√©!";
            }

            // --- M·ªöI: So s√°nh & T∆∞ v·∫•n ---
            if (input.includes('python') && (input.includes('java') || input.includes('c++') || input.includes('js'))) {
                return "M·ªói ng√¥n ng·ªØ ƒë·ªÅu c√≥ ∆∞u ƒëi·ªÉm ri√™ng. Python n·ªïi b·∫≠t v√¨ c√∫ ph√°p ƒë∆°n gi·∫£n, d·ªÖ ƒë·ªçc v√† m·∫°nh v·ªÅ AI/Data Science.";
            }
            if (input.includes('b·∫Øt ƒë·∫ßu t·ª´ ƒë√¢u') || input.includes('l·ªô tr√¨nh')) {
                return "B·∫°n h√£y b·∫Øt ƒë·∫ßu t·ª´ b√†i 1: Gi·ªõi thi·ªáu & C√†i ƒë·∫∑t. Sau ƒë√≥ ƒëi d·∫ßn qua Bi·∫øn, ƒêi·ªÅu ki·ªán, V√≤ng l·∫∑p. ƒê·ª´ng ƒë·ªët ch√°y giai ƒëo·∫°n nh√©!";
            }

            // 2. T√¨m ki·∫øm th√¥ng minh trong n·ªôi dung b√†i h·ªçc
            for (let lesson of lessons) {
                if (input.includes(lesson.title.toLowerCase()) || lesson.content.toLowerCase().includes(input)) {
                    lastChatTopic = null; // Reset topic v√¨ ƒë√¢y l√† c√¢u h·ªèi m·ªõi
                    return `T√¥i th·∫•y ch·ªß ƒë·ªÅ n√†y c√≥ trong b√†i <strong>"${lesson.title}"</strong>. B·∫°n h√£y m·ªü b√†i ƒë√≥ ra xem chi ti·∫øt nh√©!`;
                }
            }

            // 3. B·ªô t·ª´ kh√≥a ki·∫øn th·ª©c (ƒê√£ n√¢ng c·∫•p)
            const keywords = {
                'bi·∫øn': {
                    def: 'Bi·∫øn d√πng ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu. V√≠ d·ª•: <code>x = 10</code>',
                    use: 'N√≥ ƒë∆∞·ª£c d√πng ƒë·ªÉ ƒë·∫∑t t√™n cho m·ªôt gi√° tr·ªã ƒë·ªÉ b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng l·∫°i gi√° tr·ªã ƒë√≥ ·ªü nhi·ªÅu n∆°i trong ch∆∞∆°ng tr√¨nh, gi√∫p code d·ªÖ ƒë·ªçc v√† d·ªÖ b·∫£o tr√¨ h∆°n.',
                    example: 'H√£y xem v√≠ d·ª• n√†y:<pre><code class="language-python"># Thay v√¨ l·∫∑p l·∫°i s·ªë 3.14\npi = 3.14\nban_kinh = 5\ndien_tich = pi * ban_kinh * ban_kinh\nprint(dien_tich)</code></pre>'
                },
                'if': {
                    def: 'L·ªánh <code>if</code> d√πng ƒë·ªÉ ki·ªÉm tra ƒëi·ªÅu ki·ªán. N·∫øu ƒë√∫ng th√¨ th·ª±c hi·ªán code b√™n trong.',
                    use: 'D√πng khi b·∫°n mu·ªën ch∆∞∆°ng tr√¨nh r·∫Ω nh√°nh, th·ª±c hi·ªán c√°c h√†nh ƒë·ªông kh√°c nhau d·ª±a tr√™n m·ªôt ƒëi·ªÅu ki·ªán. V√≠ d·ª•: ki·ªÉm tra ƒëi·ªÉm s·ªë ƒë·ªÉ x·∫øp lo·∫°i, ki·ªÉm tra m·∫≠t kh·∫©u.',
                    example: 'Ki·ªÉm tra tu·ªïi ƒë·ªÉ xem phim:<pre><code class="language-python">tuoi = 15\nif tuoi >= 18:\n    print("B·∫°n ƒë∆∞·ª£c ph√©p xem phim n√†y.")\nelse:\n    print("B·∫°n ch∆∞a ƒë·ªß tu·ªïi.")</code></pre>'
                },
                'else': { def: 'L·ªánh <code>else</code> ƒëi k√®m v·ªõi if, th·ª±c hi·ªán khi ƒëi·ªÅu ki·ªán if sai.' },
                'elif': { def: 'Vi·∫øt t·∫Øt c·ªßa "else if", d√πng ƒë·ªÉ ki·ªÉm tra th√™m ƒëi·ªÅu ki·ªán kh√°c n·∫øu ƒëi·ªÅu ki·ªán if ƒë·∫ßu ti√™n sai.' },
                'for': {
                    def: 'V√≤ng l·∫∑p <code>for</code> d√πng ƒë·ªÉ l·∫∑p qua m·ªôt danh s√°ch ho·∫∑c d√£y s·ªë.',
                    use: 'D√πng khi b·∫°n bi·∫øt ch√≠nh x√°c s·ªë l·∫ßn c·∫ßn l·∫∑p, ho·∫∑c mu·ªën duy·ªát qua t·ª´ng ph·∫ßn t·ª≠ c·ªßa m·ªôt ƒë·ªëi t∆∞·ª£ng (nh∆∞ List, String). V√≠ d·ª•: in ra t·∫•t c·∫£ c√°c m√≥n trong th·ª±c ƒë∆°n.',
                    example: 'In ra c√°c ph·∫ßn t·ª≠ c·ªßa m·ªôt danh s√°ch:<pre><code class="language-python">trai_cay = ["T√°o", "Chu·ªëi", "Cam"]\nfor item in trai_cay:\n    print(f"H√¥m nay ƒÉn {item}")</code></pre>'
                },
                'while': {
                    def: 'V√≤ng l·∫∑p <code>while</code> ch·∫°y li√™n t·ª•c khi ƒëi·ªÅu ki·ªán c√≤n ƒë√∫ng.',
                    use: 'D√πng khi b·∫°n kh√¥ng bi·∫øt tr∆∞·ªõc s·ªë l·∫ßn l·∫∑p, v√† v√≤ng l·∫∑p s·∫Ω d·ª´ng l·∫°i khi m·ªôt ƒëi·ªÅu ki·ªán n√†o ƒë√≥ kh√¥ng c√≤n ƒë√∫ng n·ªØa. V√≠ d·ª•: game loop, ch·ªù ng∆∞·ªùi d√πng nh·∫≠p ƒë√∫ng m·∫≠t kh·∫©u.',
                    example: 'ƒê·∫øm ng∆∞·ª£c t·ª´ 5 v·ªÅ 1:<pre><code class="language-python">dem = 5\nwhile dem > 0:\n    print(dem)\n    dem -= 1 # Quan tr·ªçng: ph·∫£i thay ƒë·ªïi bi·∫øn ƒëi·ªÅu ki·ªán\nprint("B·∫Øt ƒë·∫ßu!")</code></pre>'
                },
                'def': { def: 'T·ª´ kh√≥a <code>def</code> d√πng ƒë·ªÉ ƒë·ªãnh nghƒ©a m·ªôt h√†m (function) m·ªõi.' },
                'return': { def: 'D√πng ƒë·ªÉ tr·∫£ v·ªÅ m·ªôt gi√° tr·ªã t·ª´ m·ªôt h√†m.' },
                'list': {
                    def: 'List l√† danh s√°ch c√°c ph·∫ßn t·ª≠, ƒë·∫∑t trong d·∫•u ngo·∫∑c vu√¥ng <code>[]</code>. V√≠ d·ª•: <code>[1, 2, 3]</code>',
                    use: 'D√πng ƒë·ªÉ l∆∞u tr·ªØ m·ªôt t·∫≠p h·ª£p c√°c ƒë·ªëi t∆∞·ª£ng c√≥ th·ª© t·ª± v√† c√≥ th·ªÉ thay ƒë·ªïi ƒë∆∞·ª£c. ƒê√¢y l√† c·∫•u tr√∫c d·ªØ li·ªáu ph·ªï bi·∫øn nh·∫•t trong Python.',
                    example: 'Qu·∫£n l√Ω danh s√°ch c√¥ng vi·ªác:<pre><code class="language-python">todo_list = ["H·ªçc Python", "L√†m b√†i t·∫≠p"]\ntodo_list.append("ƒêi ng·ªß") # Th√™m vi·ªác m·ªõi\nprint(todo_list[0]) # In ra "H·ªçc Python"\ntodo_list.remove("ƒêi ng·ªß") # X√≥a vi·ªác\nprint(todo_list)</code></pre>'
                },
                'tuple': { def: 'Tuple gi·ªëng List nh∆∞ng kh√¥ng th·ªÉ thay ƒë·ªïi gi√° tr·ªã, ƒë·∫∑t trong ngo·∫∑c tr√≤n <code>()</code>.' },
                'dict': { def: 'Dictionary l∆∞u d·ªØ li·ªáu d·∫°ng key:value, ƒë·∫∑t trong ngo·∫∑c nh·ªçn <code>{}</code>.' },
                'set': { def: 'Set l√† t·∫≠p h·ª£p c√°c ph·∫ßn t·ª≠ kh√¥ng tr√πng l·∫∑p.' },
                'print': { def: 'H√†m <code>print()</code> d√πng ƒë·ªÉ xu·∫•t d·ªØ li·ªáu ra m√†n h√¨nh.' },
                'input': { def: 'H√†m <code>input()</code> d√πng ƒë·ªÉ nh·∫≠n d·ªØ li·ªáu t·ª´ b√†n ph√≠m ng∆∞·ªùi d√πng.' },
                'int': { def: 'Ki·ªÉu s·ªë nguy√™n (Integer).' },
                'float': { def: 'Ki·ªÉu s·ªë th·ª±c (Floating point).' },
                'str': { def: 'Ki·ªÉu chu·ªói k√Ω t·ª± (String).' },
                'bool': { def: 'Ki·ªÉu logic (Boolean): True ho·∫∑c False.' },
                'l·ªói': { def: 'N·∫øu g·∫∑p l·ªói, h√£y ki·ªÉm tra k·ªπ c√∫ ph√°p, d·∫•u hai ch·∫•m (:) v√† th·ª•t ƒë·∫ßu d√≤ng.' },
                'bug': { def: 'Bug l√† l·ªói ph·∫ßn m·ªÅm. Debug l√† qu√° tr√¨nh t√¨m v√† s·ª≠a l·ªói ƒë√≥.' },
                'ide': { def: 'M√¥i tr∆∞·ªùng ph√°t tri·ªÉn t√≠ch h·ª£p, n∆°i b·∫°n vi·∫øt code (nh∆∞ VS Code, PyCharm).' },
                'comment': { def: 'Ghi ch√∫ trong code, b·∫Øt ƒë·∫ßu b·∫±ng d·∫•u <code>#</code> trong Python.' }
            };

            for (let key in keywords) {
                if (input.includes(key)) {
                    lastChatTopic = key; // GHI NH·ªö ch·ªß ƒë·ªÅ
                    return keywords[key].def; // Tr·∫£ v·ªÅ ƒë·ªãnh nghƒ©a
                }
            }

            // Fallback responses (R·∫Ω nh√°nh khi kh√¥ng hi·ªÉu)
            lastChatTopic = null; // Reset topic n·∫øu kh√¥ng t√¨m th·∫•y g√¨
            const fallbacks = [
                "Xin l·ªói, ki·∫øn th·ª©c n√†y t√¥i ch∆∞a ƒë∆∞·ª£c h·ªçc. T√¥i s·∫Ω c·ªë g·∫Øng c·∫≠p nh·∫≠t trong t∆∞∆°ng lai!",
                "C√¢u n√†y kh√≥ qu√°! B·∫°n c√≥ th·ªÉ h·ªèi l·∫°i ƒë∆°n gi·∫£n h∆°n v·ªÅ Python ƒë∆∞·ª£c kh√¥ng?",
                "T√¥i ch∆∞a hi·ªÉu √Ω b·∫°n l·∫Øm. B·∫°n ƒëang h·ªèi v·ªÅ code hay l√Ω thuy·∫øt?",
                "Hmm, t√¥i ƒëang suy nghƒ©... C√≥ l·∫Ω b·∫°n n√™n th·ª≠ t√¨m trong danh s√°ch b√†i h·ªçc xem sao."
            ];
            return fallbacks[Math.floor(Math.random() * fallbacks.length)];
        }
        function addMessage(text, sender) {
            const chatBody = document.getElementById('chat-messages');
            const isUser = sender === 'user';
            const align = isUser ? 'justify-end' : 'justify-start';
            const bg = isUser ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-gray-700 text-gray-200 rounded-tl-none';
            
            chatBody.innerHTML += `
                <div class="flex ${align}">
                    <div class="${bg} rounded-2xl p-3 max-w-[85%] text-sm shadow-sm break-words">
                        ${text}
                    </div>
                </div>
            `;
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // --- UTILITY FUNCTIONS (Pomodoro, TTS) ---
        let timerInterval;
        let timeLeft = 25 * 60;
        let isTimerRunning = false;

        function togglePomodoro() {
            const icon = document.getElementById('pomodoro-icon');
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
            } else {
                isTimerRunning = true;
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
                timerInterval = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        const minutes = Math.floor(timeLeft / 60);
                        const seconds = timeLeft % 60;
                        document.getElementById('pomodoro-timer').innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    } else {
                        clearInterval(timerInterval);
                        isTimerRunning = false;
                        alert("H·∫øt gi·ªù l√†m vi·ªác! H√£y ngh·ªâ ng∆°i ch√∫t nh√©.");
                        timeLeft = 25 * 60;
                        icon.classList.remove('fa-pause');
                        icon.classList.add('fa-play');
                    }
                }, 1000);
            }
        }

        function speakContent() {
            const content = document.querySelector('.prose').innerText;
            const utterance = new SpeechSynthesisUtterance(content);
            utterance.lang = 'vi-VN'; // C·ªë g·∫Øng d√πng gi·ªçng Vi·ªát
            utterance.rate = 1.0;
            window.speechSynthesis.speak(utterance);
        }

        function toggleCheatsheet() {
            const modal = document.getElementById('cheatsheet-modal');
            modal.classList.toggle('hidden');
        }

        function runCode(lessonId) {
            const outputDivId = `output-${lessonId}`;
            const outputDiv = document.getElementById(outputDivId);
            const code = document.getElementById(`code-editor-${lessonId}`).value;
            
            outputDiv.innerHTML = '<span class="text-yellow-400">ƒêang kh·ªüi t·∫°o Python...</span>';
            
            if (window.execute_python) {
                // G·ªçi h√†m Python ƒë√£ ƒë∆∞·ª£c expose ra window
                window.execute_python(code, outputDivId);
                
                // Mark as completed if not already
                if (!completedLessons.includes(lessonId)) {
                    completedLessons.push(lessonId);
                    localStorage.setItem('pymaster_completed', JSON.stringify(completedLessons));
                    renderSidebarLessons(); // Re-render to show checkmark
                    updateProgress();
                }
            } else {
                outputDiv.innerHTML = '<span class="text-red-400">M√¥i tr∆∞·ªùng Python ch∆∞a t·∫£i xong. Vui l√≤ng ƒë·ª£i v√†i gi√¢y v√† th·ª≠ l·∫°i...</span>';
            }
        }

        function renderQuiz(container) {
            let html = `<div class="max-w-3xl mx-auto space-y-8 fade-in">`;
            
            quizzes.forEach((q, idx) => {
                html += `
                    <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 quiz-card" id="quiz-${idx}">
                        <h4 class="text-lg font-bold text-white mb-4">C√¢u ${idx + 1}: ${q.question}</h4>
                        <div class="space-y-3">
                            ${q.options.map((opt, optIdx) => `
                                <button onclick="checkAnswer(${idx}, ${optIdx}, ${q.correct})" class="quiz-opt w-full text-left p-3 rounded-lg bg-gray-700 hover:bg-gray-600 transition border border-transparent">
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                        <div class="mt-4 hidden result-msg font-bold"></div>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }

        let currentFlashcardIdx = 0;
        let isFlashcardFlipped = false;

        function renderFlashcards(container) {
            const card = flashcardsData[currentFlashcardIdx];
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full fade-in">
                    <div class="perspective-1000 w-full max-w-lg h-80 cursor-pointer group" onclick="flipFlashcard()">
                        <div id="flashcard-inner" class="relative w-full h-full text-center transition-transform duration-700 transform-style-3d ${isFlashcardFlipped ? 'rotate-y-180' : ''}">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-gray-800 to-gray-900 border-2 border-blue-500/50 rounded-2xl shadow-2xl flex flex-col items-center justify-center p-8">
                                <span class="text-gray-400 text-sm uppercase tracking-widest mb-4">Thu·∫≠t ng·ªØ</span>
                                <h3 class="text-4xl font-bold text-white font-mono">${card.term}</h3>
                                <p class="text-gray-500 text-xs mt-8 absolute bottom-6">Nh·∫•n ƒë·ªÉ l·∫≠t</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-gradient-to-br from-blue-900 to-purple-900 border-2 border-purple-500/50 rounded-2xl shadow-2xl flex flex-col items-center justify-center p-8">
                                <span class="text-blue-300 text-sm uppercase tracking-widest mb-4">ƒê·ªãnh nghƒ©a</span>
                                <p class="text-xl text-white leading-relaxed">${card.def}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-6 mt-10">
                        <button onclick="prevFlashcard(event)" class="p-4 rounded-full bg-gray-800 hover:bg-gray-700 text-white transition shadow-lg border border-gray-600">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        <span class="text-gray-400 font-mono">${currentFlashcardIdx + 1} / ${flashcardsData.length}</span>
                        <button onclick="nextFlashcard(event)" class="p-4 rounded-full bg-gray-800 hover:bg-gray-700 text-white transition shadow-lg border border-gray-600">
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function flipFlashcard() {
            isFlashcardFlipped = !isFlashcardFlipped;
            const el = document.getElementById('flashcard-inner');
            if (isFlashcardFlipped) el.classList.add('rotate-y-180');
            else el.classList.remove('rotate-y-180');
        }

        function nextFlashcard(e) {
            e.stopPropagation();
            isFlashcardFlipped = false;
            currentFlashcardIdx = (currentFlashcardIdx + 1) % flashcardsData.length;
            renderView('flashcards');
        }

        function prevFlashcard(e) {
            e.stopPropagation();
            isFlashcardFlipped = false;
            currentFlashcardIdx = (currentFlashcardIdx - 1 + flashcardsData.length) % flashcardsData.length;
            renderView('flashcards');
        }

        // --- PUZZLE GAME FUNCTIONS ---
        let currentPuzzleState = {
            source: [],
            target: [],
            correct: []
        };

        function renderPuzzlesList(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in">
                    ${puzzlesData.map(p => `
                        <div onclick="loadPuzzleGame('${p.id}')" class="bg-gray-800 p-6 rounded-xl border border-gray-700 hover:border-indigo-500 cursor-pointer transition hover:shadow-lg hover:shadow-indigo-500/20 group">
                            <div class="flex justify-between items-start mb-4">
                                <div class="bg-indigo-900/50 p-3 rounded-lg text-indigo-400 group-hover:text-white group-hover:bg-indigo-600 transition">
                                    <i class="fa-solid fa-puzzle-piece text-2xl"></i>
                                </div>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2">${p.title}</h3>
                            <p class="text-gray-400 text-sm">${p.desc}</p>
                        </div>
                    `).join('')}
                </div>
                <div id="puzzle-game-area" class="hidden mt-8 h-full flex-col fade-in"></div>
            `;
        }

        function loadPuzzleGame(id) {
            const puzzle = puzzlesData.find(p => p.id === id);
            if (!puzzle) return;

            // Shuffle lines
            const shuffled = [...puzzle.correctLines].sort(() => Math.random() - 0.5);
            
            currentPuzzleState = {
                id: id,
                source: shuffled,
                target: [],
                correct: puzzle.correctLines
            };

            renderPuzzleBoard();
        }

        function renderPuzzleBoard() {
            const container = document.getElementById('content-area');
            const puzzle = puzzlesData.find(p => p.id === currentPuzzleState.id);
            
            container.innerHTML = `
                <div class="flex flex-col h-full fade-in max-w-5xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <button onclick="renderView('puzzles')" class="text-gray-400 hover:text-white mb-2 text-sm"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i danh s√°ch</button>
                            <h2 class="text-2xl font-bold text-white">${puzzle.title}</h2>
                            <p class="text-gray-400 text-sm">${puzzle.desc}</p>
                        </div>
                        <button onclick="checkPuzzleResult()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2">
                            <i class="fa-solid fa-check"></i> Ki·ªÉm tra
                        </button>
                    </div>

                    <div class="flex-1 flex flex-col md:flex-row gap-8 overflow-hidden">
                        <!-- Source Area -->
                        <div class="md:w-1/2 bg-gray-800/50 rounded-xl border border-gray-700 p-4 flex flex-col">
                            <h4 class="text-gray-400 text-xs uppercase font-bold mb-4">M·∫£nh gh√©p (B·∫•m ƒë·ªÉ ch·ªçn)</h4>
                            <div class="space-y-3 overflow-y-auto flex-1">
                                ${currentPuzzleState.source.map((line, idx) => `
                                    <div onclick="moveBlock(${idx}, 'source')" class="puzzle-block bg-gray-700 hover:bg-gray-600 p-3 rounded-lg border border-gray-600 text-gray-200 font-mono text-sm shadow-sm flex items-center">
                                        <i class="fa-solid fa-grip-lines text-gray-500 mr-3"></i> ${line}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Target Area -->
                        <div class="md:w-1/2 bg-gray-900 rounded-xl border-2 border-dashed border-gray-700 p-4 flex flex-col relative">
                            <h4 class="text-gray-400 text-xs uppercase font-bold mb-4">Khu v·ª±c s·∫Øp x·∫øp (Code c·ªßa b·∫°n)</h4>
                            <div class="space-y-3 overflow-y-auto flex-1" id="target-zone">
                                ${currentPuzzleState.target.length === 0 ? '<div class="text-gray-600 text-center mt-10 italic">B·∫•m v√†o c√°c m·∫£nh gh√©p b√™n tr√°i ƒë·ªÉ chuy·ªÉn sang ƒë√¢y</div>' : ''}
                                ${currentPuzzleState.target.map((line, idx) => `
                                    <div onclick="moveBlock(${idx}, 'target')" class="puzzle-block bg-indigo-900/40 hover:bg-indigo-900/60 p-3 rounded-lg border border-indigo-500/30 text-indigo-100 font-mono text-sm shadow-sm flex items-center">
                                        <span class="text-indigo-500/50 mr-3 text-xs w-4">${idx + 1}</span> ${line}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function moveBlock(idx, from) {
            if (from === 'source') {
                const item = currentPuzzleState.source.splice(idx, 1)[0];
                currentPuzzleState.target.push(item);
            } else {
                const item = currentPuzzleState.target.splice(idx, 1)[0];
                currentPuzzleState.source.push(item);
            }
            renderPuzzleBoard();
        }

        function checkPuzzleResult() {
            const userCode = currentPuzzleState.target.join('\n');
            const correctCode = currentPuzzleState.correct.join('\n');
            
            if (userCode === correctCode) {
                // SAVE PUZZLE STATS
                let solved = JSON.parse(localStorage.getItem('pymaster_solved_puzzles') || '[]');
                if (!solved.includes(currentPuzzleState.id)) {
                    solved.push(currentPuzzleState.id);
                    localStorage.setItem('pymaster_solved_puzzles', JSON.stringify(solved));
                }

                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                alert("Ch√≠nh x√°c! B·∫°n l√† thi√™n t√†i logic! üéâ");
            } else {
                alert("Ch∆∞a ƒë√∫ng r·ªìi. H√£y ki·ªÉm tra l·∫°i th·ª© t·ª± logic ho·∫∑c th·ª•t ƒë·∫ßu d√≤ng nh√©!");
            }
        }

        // --- TYPING GAME FUNCTIONS ---
        let typingState = {
            snippet: "",
            currentIndex: 0,
            startTime: null,
            errors: 0,
            isFinished: false
        };

        function renderTypingGame(container) {
            // Pick random snippet
            const snippetObj = typingSnippets[Math.floor(Math.random() * typingSnippets.length)];
            typingState = {
                snippet: snippetObj.code,
                currentIndex: 0,
                startTime: null,
                errors: 0,
                isFinished: false
            };

            container.innerHTML = `
                <div class="flex flex-col h-full fade-in max-w-4xl mx-auto items-center justify-center" tabindex="0" id="typing-container" onkeydown="handleTypingKey(event)">
                    <div class="w-full flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-white mb-2">Speed Coding</h2>
                            <p class="text-gray-400">G√µ l·∫°i ƒëo·∫°n code b√™n d∆∞·ªõi ch√≠nh x√°c nh·∫•t c√≥ th·ªÉ.</p>
                        </div>
                        <div class="flex gap-6 text-xl font-mono">
                            <div class="text-center">
                                <div class="text-xs text-gray-500 uppercase">WPM</div>
                                <div id="typing-wpm" class="text-cyan-400 font-bold">0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 uppercase">ƒê·ªô ch√≠nh x√°c</div>
                                <div id="typing-accuracy" class="text-green-400 font-bold">100%</div>
                            </div>
                        </div>
                    </div>

                    <div class="w-full bg-gray-800/80 backdrop-blur border border-gray-600 rounded-xl p-8 shadow-2xl relative overflow-hidden group" onclick="document.getElementById('typing-container').focus()">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gray-700">
                            <div id="typing-progress" class="h-full bg-cyan-500 w-0 transition-all duration-100"></div>
                        </div>
                        <div class="absolute top-4 right-4 text-xs text-gray-500 flex items-center gap-2">
                            <i class="fa-solid fa-keyboard"></i> Nh·∫•n ph√≠m b·∫•t k·ª≥ ƒë·ªÉ b·∫Øt ƒë·∫ßu
                        </div>
                        
                        <div id="typing-display" class="font-mono text-xl leading-relaxed text-gray-500 whitespace-pre-wrap select-none">
                            ${renderTypingHTML(typingState.snippet)}
                        </div>

                        <div id="typing-result" class="hidden absolute inset-0 bg-gray-900/95 flex flex-col items-center justify-center z-10 fade-in">
                            <i class="fa-solid fa-trophy text-5xl text-yellow-400 mb-4 animate-bounce"></i>
                            <h3 class="text-3xl font-bold text-white mb-2">Ho√†n th√†nh!</h3>
                            <p class="text-gray-300 mb-6">B·∫°n ƒë√£ g√µ xong ƒëo·∫°n code n√†y.</p>
                            <button onclick="renderView('typing')" class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                                <i class="fa-solid fa-rotate-right mr-2"></i> Th·ª≠ ƒëo·∫°n kh√°c
                            </button>
                        </div>
                    </div>
                    
                    <p class="mt-6 text-gray-500 text-sm italic"><i class="fa-solid fa-circle-info mr-2"></i>Click v√†o khung v√† b·∫Øt ƒë·∫ßu g√µ. Enter ƒë·ªÉ xu·ªëng d√≤ng.</p>
                </div>
            `;
            
            // Focus container to capture keys
            setTimeout(() => document.getElementById('typing-container').focus(), 100);
        }

        function renderTypingHTML(code) {
            return code.split('').map((char, idx) => 
                `<span class="t-char ${idx === 0 ? 'current' : ''}" id="char-${idx}">${char}</span>`
            ).join('');
        }

        function handleTypingKey(e) {
            if (typingState.isFinished) return;
            
            // Ignore modifier keys
            if (e.key === 'Shift' || e.key === 'Control' || e.key === 'Alt' || e.key === 'Meta') return;
            
            // Handle Backspace (X·ª≠ l√Ω ph√≠m X√≥a)
            if (e.key === 'Backspace') {
                if (typingState.currentIndex > 0) {
                    const currentEl = document.getElementById(`char-${typingState.currentIndex}`);
                    if (currentEl) currentEl.classList.remove('current');
                    
                    typingState.currentIndex--;
                    
                    const prevEl = document.getElementById(`char-${typingState.currentIndex}`);
                    if (prevEl) prevEl.className = 't-char current';
                    
                    // Update progress
                    const percent = (typingState.currentIndex / typingState.snippet.length) * 100;
                    document.getElementById('typing-progress').style.width = percent + '%';
                }
                return;
            }

            // Prevent default scrolling for Space
            if(e.key === ' ') e.preventDefault();
            
            if (!typingState.startTime) typingState.startTime = Date.now();

            const currentChar = typingState.snippet[typingState.currentIndex];
            const charEl = document.getElementById(`char-${typingState.currentIndex}`);
            
            // Mapping Enter to \n
            let inputKey = e.key;
            if (inputKey === 'Enter') inputKey = '\n';
            
            if (inputKey === currentChar) {
                charEl.className = 't-char correct';
            } else {
                charEl.className = 't-char incorrect';
                typingState.errors++;
            }

            // Move cursor
            typingState.currentIndex++;
            
            // Update stats
            const timeElapsed = (Date.now() - typingState.startTime) / 1000 / 60; // in minutes
            const wpm = Math.round((typingState.currentIndex / 5) / (timeElapsed || 1/60));
            const accuracy = Math.round(((typingState.currentIndex - typingState.errors) / typingState.currentIndex) * 100);
            
            document.getElementById('typing-wpm').innerText = wpm;
            document.getElementById('typing-accuracy').innerText = accuracy + '%';
            
            // Update progress bar
            const percent = (typingState.currentIndex / typingState.snippet.length) * 100;
            document.getElementById('typing-progress').style.width = percent + '%';

            // Check finish
            if (typingState.currentIndex >= typingState.snippet.length) {
                // SAVE WPM STATS
                const currentMax = parseInt(localStorage.getItem('pymaster_best_wpm') || '0');
                const wpm = parseInt(document.getElementById('typing-wpm').innerText);
                if (wpm > currentMax) localStorage.setItem('pymaster_best_wpm', wpm);

                typingState.isFinished = true;
                document.getElementById('typing-result').classList.remove('hidden');
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } else {
                // Set next char as current
                const nextEl = document.getElementById(`char-${typingState.currentIndex}`);
                if (nextEl) nextEl.classList.add('current');
            }
        }

        function checkAnswer(quizIdx, selectedIdx, correctIdx) {
            const card = document.getElementById(`quiz-${quizIdx}`);
            const opts = card.querySelectorAll('.quiz-opt');
            const msg = card.querySelector('.result-msg');
            
            // Disable all buttons
            opts.forEach(btn => btn.disabled = true);
            
            if (selectedIdx === correctIdx) {
                opts[selectedIdx].classList.remove('bg-gray-700');
                opts[selectedIdx].classList.add('bg-green-600', 'text-white');
                msg.innerText = "Ch√≠nh x√°c! üéâ";
                msg.classList.add('text-green-400');
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } else {
                opts[selectedIdx].classList.remove('bg-gray-700');
                opts[selectedIdx].classList.add('bg-red-600', 'text-white');
                opts[correctIdx].classList.remove('bg-gray-700');
                opts[correctIdx].classList.add('bg-green-600', 'text-white'); // Show correct answer
                msg.innerText = "Sai r·ªìi! ƒê√°p √°n ƒë√∫ng ƒë∆∞·ª£c t√¥ xanh.";
                msg.classList.add('text-red-400');
            }
            msg.classList.remove('hidden');
        }

        function updateProgress() {
            const bar = document.getElementById('progress-bar');
            const text = document.getElementById('progress-text');
            
            const total = lessons.length;
            const completed = completedLessons.length;
            const percent = Math.round((completed / total) * 100);
            
            bar.style.width = percent + '%';
            text.innerText = percent + '%';

            // Show certificate button if 100%
            const certBtn = document.getElementById('btn-certificate');
            if (percent === 100) {
                certBtn.classList.remove('hidden');
            }
        }

        // --- PROFILE & MATRIX FUNCTIONS ---
        // Render Profile (Ch·ªâ hi·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p)
        function renderProfile(container) {
            // Calculate Stats
            const completedCount = completedLessons.length;
            const solvedPuzzles = JSON.parse(localStorage.getItem('pymaster_solved_puzzles') || '[]').length;
            const bestWpm = parseInt(localStorage.getItem('pymaster_best_wpm') || '0');
            
            // XP Calculation
            // Lesson = 100 XP, Puzzle = 50 XP, WPM = 10 XP per point
            const xp = (completedCount * 100) + (solvedPuzzles * 50) + (bestWpm * 10);
            const level = Math.floor(xp / 500) + 1;
            const nextLevelXp = level * 500;
            const progressPercent = Math.min(100, Math.round((xp % 500) / 500 * 100));

            // Badges Logic
            const badges = [
                { id: 'newbie', name: 'Kh·ªüi ƒë·∫ßu', icon: 'fa-seedling', color: 'text-green-400', unlocked: completedCount >= 1, desc: 'Ho√†n th√†nh 1 b√†i h·ªçc' },
                { id: 'scholar', name: 'H·ªçc gi·∫£', icon: 'fa-graduation-cap', color: 'text-blue-400', unlocked: completedCount >= 5, desc: 'Ho√†n th√†nh 5 b√†i h·ªçc' },
                { id: 'master', name: 'Th·∫ßn ƒë·ªìng', icon: 'fa-crown', color: 'text-yellow-400', unlocked: completedCount >= 10, desc: 'Ho√†n th√†nh 10 b√†i h·ªçc' },
                { id: 'flash', name: 'Th·∫ßn t·ªëc', icon: 'fa-bolt', color: 'text-red-400', unlocked: bestWpm >= 40, desc: 'ƒê·∫°t 40 WPM g√µ code' },
                { id: 'logic', name: 'Logic', icon: 'fa-brain', color: 'text-purple-400', unlocked: solvedPuzzles >= 1, desc: 'Gi·∫£i ƒë∆∞·ª£c 1 c√¢u ƒë·ªë' }
            ];

            container.innerHTML = `
                <div class="max-w-5xl mx-auto fade-in space-y-8">
                    <!-- Header Card -->
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 p-8 rounded-2xl border border-gray-700 shadow-2xl flex flex-col md:flex-row items-center gap-8 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -mr-16 -mt-16"></div>
                        
                        <div class="relative">
                            <div class="w-32 h-32 rounded-full bg-gray-700 border-4 border-blue-500 flex items-center justify-center text-5xl text-gray-300 shadow-lg">
                                <i class="fa-solid fa-user-astronaut"></i>
                            </div>
                            <div class="absolute -bottom-2 -right-2 bg-yellow-500 text-black font-bold w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-800">
                                ${level}
                            </div>
                        </div>
                        
                        <div class="flex-1 text-center md:text-left z-10">
                            <h2 class="text-3xl font-bold text-white mb-2">${currentUser}</h2>
                            <p class="text-gray-400 mb-4">Ti·∫øp t·ª•c c·ªë g·∫Øng nh√©! B·∫°n ƒëang l√†m r·∫•t t·ªët.</p>
                            
                            <div class="w-full bg-gray-700 rounded-full h-4 mb-2 overflow-hidden">
                                <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-full transition-all duration-1000" style="width: ${progressPercent}%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-400 font-mono">
                                <span>XP: ${xp}</span>
                                <span>Next Level: ${nextLevelXp}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 flex items-center gap-4">
                            <div class="p-4 bg-green-900/30 text-green-400 rounded-lg text-2xl"><i class="fa-solid fa-check-circle"></i></div>
                            <div>
                                <div class="text-2xl font-bold text-white">${completedCount}</div>
                                <div class="text-sm text-gray-400">B√†i h·ªçc ho√†n th√†nh</div>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 flex items-center gap-4">
                            <div class="p-4 bg-cyan-900/30 text-cyan-400 rounded-lg text-2xl"><i class="fa-solid fa-keyboard"></i></div>
                            <div>
                                <div class="text-2xl font-bold text-white">${bestWpm} <span class="text-xs">WPM</span></div>
                                <div class="text-sm text-gray-400">T·ªëc ƒë·ªô g√µ t·ªët nh·∫•t</div>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 flex items-center gap-4">
                            <div class="p-4 bg-indigo-900/30 text-indigo-400 rounded-lg text-2xl"><i class="fa-solid fa-puzzle-piece"></i></div>
                            <div>
                                <div class="text-2xl font-bold text-white">${solvedPuzzles}</div>
                                <div class="text-sm text-gray-400">C√¢u ƒë·ªë ƒë√£ gi·∫£i</div>
                            </div>
                        </div>
                    </div>

                    <!-- Badges -->
                    <h3 class="text-xl font-bold text-white mt-8 mb-4"><i class="fa-solid fa-medal mr-2 text-yellow-500"></i>B·ªô s∆∞u t·∫≠p Huy hi·ªáu</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        ${badges.map(b => `
                            <div class="bg-gray-800 p-4 rounded-xl border ${b.unlocked ? 'border-gray-600 bg-gray-800' : 'border-gray-700 bg-gray-800/50 opacity-50'} flex flex-col items-center text-center transition hover:scale-105">
                                <div class="text-4xl mb-3 ${b.unlocked ? b.color : 'text-gray-600'}">
                                    <i class="fa-solid ${b.icon}"></i>
                                </div>
                                <div class="font-bold text-sm text-white mb-1">${b.name}</div>
                                <div class="text-[10px] text-gray-400">${b.desc}</div>
                                ${b.unlocked ? '<div class="mt-2 text-[10px] bg-green-900 text-green-300 px-2 py-0.5 rounded-full">ƒê√£ nh·∫≠n</div>' : '<div class="mt-2 text-[10px] text-gray-500"><i class="fa-solid fa-lock"></i></div>'}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="text-center mt-8">
                        <button onclick="handleLogout()" class="text-red-400 hover:text-red-300 border border-red-900 hover:bg-red-900/30 px-6 py-2 rounded-lg transition">
                            <i class="fa-solid fa-right-from-bracket mr-2"></i> ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                </div>
            `;
        }

        // Render Login Form (Hi·ªán khi ch∆∞a ƒëƒÉng nh·∫≠p)
        function renderLogin(container, mode = 'login') {
            const isLogin = mode === 'login';
            container.innerHTML = `
                <div class="flex items-center justify-center h-full fade-in">
                    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700 w-full max-w-md relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                        <div class="text-center mb-8">
                            <i class="fa-brands fa-python text-5xl text-yellow-400 mb-4"></i>
                            <h2 class="text-2xl font-bold text-white">${isLogin ? 'ƒêƒÉng nh·∫≠p' : 'T·∫°o t√†i kho·∫£n'}</h2>
                            <p class="text-gray-400 text-sm">${isLogin ? 'Ch√†o m·ª´ng tr·ªü l·∫°i! H√£y ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c.' : 'ƒêƒÉng k√Ω ƒë·ªÉ l∆∞u tr·ªØ ti·∫øn ƒë·ªô h·ªçc t·∫≠p c·ªßa b·∫°n.'}</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-400 text-xs uppercase font-bold mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                                <input type="text" id="auth-username" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition" placeholder="Nh·∫≠p t√™n...">
                            </div>
                            <div>
                                <label class="block text-gray-400 text-xs uppercase font-bold mb-2">M·∫≠t kh·∫©u</label>
                                <input type="password" id="auth-password" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
                            </div>
                            ${!isLogin ? `
                            <div>
                                <label class="block text-gray-400 text-xs uppercase font-bold mb-2">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u</label>
                                <input type="password" id="auth-confirm-password" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u...">
                            </div>
                            ` : ''}
                            
                            <div id="auth-error" class="text-red-400 text-xs hidden bg-red-900/20 p-2 rounded border border-red-900"></div>

                            <button onclick="${isLogin ? 'handleLoginSubmit()' : 'handleRegisterSubmit()'}" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-[1.02]">
                                ${isLogin ? 'ƒêƒÉng nh·∫≠p' : 'ƒêƒÉng k√Ω'} <i class="fa-solid fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                        
                        <div class="text-center text-gray-400 text-sm mt-6">
                            ${isLogin ? 'Ch∆∞a c√≥ t√†i kho·∫£n?' : 'ƒê√£ c√≥ t√†i kho·∫£n?'} 
                            <button onclick="renderLogin(document.getElementById('content-area'), '${isLogin ? 'register' : 'login'}')" class="text-blue-400 hover:text-blue-300 font-bold ml-1 hover:underline">
                                ${isLogin ? 'ƒêƒÉng k√Ω ngay' : 'ƒêƒÉng nh·∫≠p'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render Snippets Gallery
        function renderSnippets(container) {
            container.innerHTML = `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="mb-8 text-center">
                        <h2 class="text-3xl font-bold text-white mb-2">Th∆∞ vi·ªán Code M·∫´u</h2>
                        <p class="text-gray-400">C√°c ƒëo·∫°n code ng·∫Øn (snippets) h·ªØu √≠ch th∆∞·ªùng d√πng trong Python.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${codeSnippetsData.map((snip, idx) => `
                            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden hover:border-teal-500 transition group shadow-lg">
                                <div class="p-4 bg-gray-900 border-b border-gray-700 flex justify-between items-center">
                                    <h3 class="font-bold text-teal-400 truncate">${snip.title}</h3>
                                    <button onclick="copySnippet('${idx}')" class="text-gray-500 hover:text-white transition" title="Copy Code">
                                        <i class="fa-regular fa-copy"></i>
                                    </button>
                                </div>
                                <div class="p-4">
                                    <p class="text-xs text-gray-400 mb-3 h-8 overflow-hidden">${snip.desc}</p>
                                    <div class="relative">
                                        <pre class="text-xs bg-black/50 p-3 rounded-lg overflow-x-auto text-gray-300 font-mono border border-gray-700/50"><code id="snippet-code-${idx}">${snip.code}</code></pre>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- AUTHENTICATION LOGIC ---
        function handleHeaderLoginClick() {
            if (isLoggedIn) {
                renderView('profile');
            } else {
                renderView('profile'); // Will show login form because isLoggedIn is false
            }
        }

        function handleLoginSubmit() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');

            let users = JSON.parse(localStorage.getItem('pymaster_users') || '{}');
            
            if (!users[username] || users[username] !== password) {
                errorEl.innerText = "T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.";
                errorEl.classList.remove('hidden');
                return;
            }

            isLoggedIn = true;
            currentUser = username;
            localStorage.setItem('pymaster_is_logged_in', 'true');
            localStorage.setItem('pymaster_username', username);
            
            updateHeaderUI();
            renderView('profile'); // Switch to profile view immediately
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        function handleRegisterSubmit() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value;
            const confirm = document.getElementById('auth-confirm-password').value;
            const errorEl = document.getElementById('auth-error');

            if (!username || !password) {
                errorEl.innerText = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.";
                errorEl.classList.remove('hidden');
                return;
            }

            if (password !== confirm) {
                errorEl.innerText = "M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp.";
                errorEl.classList.remove('hidden');
                return;
            }

            let users = JSON.parse(localStorage.getItem('pymaster_users') || '{}');
            if (users[username]) {
                errorEl.innerText = "T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i.";
                errorEl.classList.remove('hidden');
                return;
            }

            users[username] = password;
            localStorage.setItem('pymaster_users', JSON.stringify(users));
            
            alert("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.");
            renderLogin(document.getElementById('content-area'), 'login');
        }

        function handleLogout() {
            if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) {
                isLoggedIn = false;
                currentUser = 'Kh√°ch';
                localStorage.removeItem('pymaster_is_logged_in');
                localStorage.removeItem('pymaster_username');
                
                updateHeaderUI();
                renderView('home');
            }
        }

        function updateHeaderUI() {
            const btn = document.getElementById('header-login-btn');
            if (isLoggedIn) {
                btn.innerHTML = `<i class="fa-solid fa-user mr-2"></i> ${currentUser}`;
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-gray-700', 'hover:bg-gray-600', 'border', 'border-gray-600');
            } else {
                btn.innerHTML = `ƒêƒÉng nh·∫≠p`;
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.remove('bg-gray-700', 'hover:bg-gray-600', 'border', 'border-gray-600');
            }
        }

        function copySnippet(idx) {
            const code = codeSnippetsData[idx].code;
            navigator.clipboard.writeText(code).then(() => {
                alert("ƒê√£ sao ch√©p code v√†o b·ªô nh·ªõ t·∫°m!");
            });
        }

        // --- BOSS BATTLE FUNCTIONS ---
        let battleState = {
            boss: null,
            playerHp: 100,
            currentQ: null,
            isOver: false
        };

        function renderBossList(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in">
                    ${bossesData.map(b => `
                        <div onclick="startBattle('${b.id}')" class="bg-gray-800 p-6 rounded-xl border border-gray-700 hover:border-red-500 cursor-pointer transition hover:shadow-lg hover:shadow-red-500/20 group relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                                <i class="fa-solid ${b.icon} text-9xl ${b.color}"></i>
                            </div>
                            <div class="relative z-10">
                                <div class="w-16 h-16 rounded-full ${b.bg} flex items-center justify-center text-3xl ${b.color} mb-4 border border-gray-600">
                                    <i class="fa-solid ${b.icon}"></i>
                                </div>
                                <h3 class="text-xl font-bold text-white mb-2">${b.name}</h3>
                                <div class="flex items-center gap-2 text-xs font-bold text-gray-400 mb-2">
                                    <span class="bg-red-900/50 text-red-400 px-2 py-1 rounded">HP: ${b.maxHp}</span>
                                    <span class="bg-yellow-900/50 text-yellow-400 px-2 py-1 rounded">XP: ${b.xpReward}</span>
                                </div>
                                <p class="text-gray-400 text-sm">${b.desc}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function startBattle(bossId) {
            const boss = bossesData.find(b => b.id === bossId);
            battleState = {
                boss: { ...boss }, // Clone to reset HP
                playerHp: 100,
                currentQ: null,
                isOver: false
            };
            renderBattleArena();
            nextBattleQuestion();
        }

        function renderBattleArena() {
            const container = document.getElementById('content-area');
            const b = battleState.boss;
            
            container.innerHTML = `
                <div class="max-w-4xl mx-auto h-full flex flex-col fade-in relative" id="battle-screen">
                    <!-- Boss Area -->
                    <div class="flex flex-col items-center justify-center py-6 relative">
                        <div id="boss-avatar" class="text-6xl ${b.color} mb-4 transition-transform duration-100"><i class="fa-solid ${b.icon}"></i></div>
                        <h2 class="text-2xl font-bold text-white mb-2">${b.name}</h2>
                        <div class="w-64 h-4 bg-gray-700 rounded-full overflow-hidden border border-gray-600 relative">
                            <div id="boss-hp-bar" class="h-full bg-red-600 transition-all duration-300" style="width: ${(b.hp / b.maxHp) * 100}%"></div>
                            <span class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white shadow-black drop-shadow-md">${b.hp}/${b.maxHp}</span>
                        </div>
                        <div id="boss-damage" class="absolute top-10 right-1/3 text-4xl font-bold text-yellow-400 hidden damage-text">-10</div>
                    </div>

                    <!-- Question Area -->
                    <div class="flex-1 flex items-center justify-center py-4">
                        <div class="bg-gray-800/90 border border-gray-600 p-6 rounded-xl w-full max-w-2xl shadow-2xl backdrop-blur-sm" id="battle-question-box">
                            <h3 class="text-lg font-bold text-white mb-6 text-center" id="battle-q-text">Loading...</h3>
                            <div class="grid grid-cols-2 gap-4" id="battle-options"></div>
                        </div>
                    </div>

                    <!-- Player Area -->
                    <div class="py-6 flex items-center gap-4 border-t border-gray-700 bg-gray-900/50 px-6 rounded-t-xl mt-auto">
                        <div class="w-12 h-12 rounded-full bg-blue-600 flex items-center justify-center text-white text-xl border-2 border-blue-400">
                            <i class="fa-solid fa-user-astronaut"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between text-xs text-gray-300 mb-1">
                                <span>${currentUser}</span>
                                <span>HP: ${battleState.playerHp}/100</span>
                            </div>
                            <div class="w-full h-3 bg-gray-700 rounded-full overflow-hidden">
                                <div id="player-hp-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: ${battleState.playerHp}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function nextBattleQuestion() {
            if (battleState.isOver) return;
            const q = battleQuestions[Math.floor(Math.random() * battleQuestions.length)];
            battleState.currentQ = q;
            
            document.getElementById('battle-q-text').innerText = q.q;
            document.getElementById('battle-options').innerHTML = q.a.map((opt, idx) => `
                <button onclick="handleBattleAnswer(${idx})" class="bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-lg font-bold transition border border-gray-600 hover:border-blue-500 text-left">
                    ${opt}
                </button>
            `).join('');
        }

        function handleBattleAnswer(idx) {
            if (battleState.isOver) return;
            const q = battleState.currentQ;
            
            if (idx === q.c) {
                // Correct -> Damage Boss
                battleState.boss.hp -= q.dmg;
                if (battleState.boss.hp < 0) battleState.boss.hp = 0;
                
                // Update UI
                document.getElementById('boss-hp-bar').style.width = (battleState.boss.hp / battleState.boss.maxHp * 100) + '%';
                
                // Animation
                const bossAvatar = document.getElementById('boss-avatar');
                bossAvatar.classList.add('shake-anim');
                setTimeout(() => bossAvatar.classList.remove('shake-anim'), 500);

                // Show damage
                const dmgText = document.getElementById('boss-damage');
                dmgText.innerText = `-${q.dmg}`;
                dmgText.classList.remove('hidden');
                setTimeout(() => dmgText.classList.add('hidden'), 1000);

                if (battleState.boss.hp <= 0) {
                    battleState.isOver = true;
                    confetti({ particleCount: 200, spread: 100 });
                    setTimeout(() => {
                        alert(`CHI·∫æN TH·∫ÆNG! B·∫°n ƒë√£ ƒë√°nh b·∫°i ${battleState.boss.name} v√† nh·∫≠n ${battleState.boss.xpReward} XP!`);
                        // Add XP logic here if needed (simplified for now)
                        renderView('boss');
                    }, 1000);
                } else {
                    setTimeout(nextBattleQuestion, 1000);
                }
            } else {
                // Wrong -> Player takes damage
                battleState.playerHp -= 20;
                if (battleState.playerHp < 0) battleState.playerHp = 0;

                document.getElementById('player-hp-bar').style.width = battleState.playerHp + '%';
                document.getElementById('battle-screen').classList.add('shake-anim');
                setTimeout(() => document.getElementById('battle-screen').classList.remove('shake-anim'), 500);

                if (battleState.playerHp <= 0) {
                    battleState.isOver = true;
                    setTimeout(() => {
                        alert("TH·∫§T B·∫†I! B·∫°n ƒë√£ h·∫øt m√°u. H√£y √¥n t·∫≠p th√™m v√† quay l·∫°i sau.");
                        renderView('boss');
                    }, 500);
                }
            }
        }

        // --- MATRIX RAIN EFFECT ---
        let matrixInterval;
        function toggleMatrixMode() {
            const canvas = document.getElementById('matrix-canvas');
            if (canvas.classList.contains('hidden')) {
                canvas.classList.remove('hidden');
                startMatrix();
            } else {
                canvas.classList.add('hidden');
                stopMatrix();
            }
        }

        function startMatrix() {
            const canvas = document.getElementById('matrix-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const katakana = '„Ç¢„Ç°„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É£„É©„ÉØ„Ç¨„Ç∂„ÉÄ„Éê„Éë„Ç§„Ç£„Ç≠„Ç∑„ÉÅ„Éã„Éí„Éü„É™„É∞„ÇÆ„Ç∏„ÉÇ„Éì„Éî„Ç¶„Ç•„ÇØ„Çπ„ÉÑ„Éå„Éï„É†„É¶„É•„É´„Ç∞„Ç∫„Éñ„ÉÖ„Éó„Ç®„Çß„Ç±„Çª„ÉÜ„Éç„Éò„É°„É¨„É±„Ç≤„Çº„Éá„Éô„Éö„Ç™„Ç©„Ç≥„ÇΩ„Éà„Éé„Éõ„É¢„É®„Éß„É≠„É≤„Ç¥„Çæ„Éâ„Éú„Éù„É¥„ÉÉ„É≥';
            const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const nums = '0123456789';
            const alphabet = katakana + latin + nums;

            const fontSize = 16;
            const columns = canvas.width / fontSize;
            const rainDrops = Array(Math.floor(columns)).fill(1);

            const draw = () => {
                ctx.fillStyle = 'rgba(15, 23, 42, 0.05)'; // Fade effect
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#0F0'; // Green text
                ctx.font = fontSize + 'px monospace';

                for (let i = 0; i < rainDrops.length; i++) {
                    const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                    ctx.fillText(text, i * fontSize, rainDrops[i] * fontSize);

                    if (rainDrops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        rainDrops[i] = 0;
                    }
                    rainDrops[i]++;
                }
            };
            matrixInterval = setInterval(draw, 30);
        }

        function stopMatrix() {
            clearInterval(matrixInterval);
        }
    </script>

    <!-- Python Worker Script -->
    <script type="py" config='{"packages": ["matplotlib", "numpy"]}'>
        import sys
        import io
        import matplotlib.pyplot as plt
        from pyscript import window, document, display

        # H√†m gi·∫£ l·∫≠p input() b·∫±ng popup c·ªßa tr√¨nh duy·ªát
        def custom_input(prompt_text=""):
            val = window.prompt(prompt_text)
            if val is None:
                return ""
            return str(val)

        def execute_python(code, output_id):
            output_element = document.getElementById(output_id)
            output_element.innerHTML = '' # X√≥a k·∫øt qu·∫£ c≈©

            # Capture stdout (print statements)
            buffer = io.StringIO()
            sys.stdout = buffer

            # H√†m custom_show ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì v√†o ƒë√∫ng div output
            def custom_show():
                display(plt.gcf(), target=output_id, append=True)
                plt.clf()

            # Monkey patch plt.show
            original_show = plt.show
            plt.show = custom_show

            try:
                # Exec the code in a clean dictionary
                exec(code, {'input': custom_input, 'display': lambda x: display(x, target=output_id, append=True)})
                
                # Hi·ªÉn th·ªã text output (n·∫øu c√≥)
                text_result = buffer.getvalue()
                if text_result:
                    div = document.createElement("div")
                    div.innerText = text_result
                    output_element.appendChild(div)
                elif len(output_element.children) == 0:
                    output_element.innerText = "Code ƒë√£ ch·∫°y xong (kh√¥ng c√≥ output)."
                
                # Update progress bar in JS
                window.updateProgress()
            except Exception as e:
                err_div = document.createElement("div")
                err_div.className = "text-red-400"
                err_div.innerText = f"L·ªói: {e}"
                output_element.appendChild(err_div)
            finally:
                plt.show = original_show

        # Expose function to JavaScript
        window.execute_python = execute_python
    </script>
</body>
</html>